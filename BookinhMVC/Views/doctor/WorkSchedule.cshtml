@model List<BookinhMVC.Models.LichLamViec>
@{
    Layout = "~/Views/Shared/_DoctorLayout.cshtml";
    ViewBag.Title = "Quản lý Lịch làm việc";
    var weekStart = (DateTime)ViewBag.WeekStart;
    var weekEnd = (DateTime)ViewBag.WeekEnd;

    // Lấy ngày hiện tại (chỉ phần ngày, không tính giờ) để so sánh
    var today = DateTime.Today;

    // Helper function để chuyển đổi số ngày trong tuần thành Tên thứ (Thứ 2 -> Chủ Nhật)
    string GetDayOfWeekName(DateTime date)
    {
        return date.DayOfWeek switch
        {
            DayOfWeek.Monday => "Thứ Hai",
            DayOfWeek.Tuesday => "Thứ Ba",
            DayOfWeek.Wednesday => "Thứ Tư",
            DayOfWeek.Thursday => "Thứ Năm",
            DayOfWeek.Friday => "Thứ Sáu",
            DayOfWeek.Saturday => "Thứ Bảy",
            DayOfWeek.Sunday => "Chủ Nhật",
            _ => "",
        };
    }
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" />

}

<style>
    /* ------------------------------------------- */
    /* --- CSS Layout Mới --- */
    /* ------------------------------------------- */
    .schedule-container {
        max-width: 1400px;
        margin: 0 auto;
    }

    .header-card {
        background: white;
        padding: 24px 28px;
        border-radius: 16px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        margin-bottom: 30px;
        border-left: 6px solid #0ea5e9;
    }

    .week-navigation {
        display: flex;
        justify-content: start;
        align-items: center;
        gap: 15px;
        margin-top: 15px;
    }

    .btn-nav {
        background: #f1f5f9;
        color: #475569;
        border: 1px solid #e2e8f0;
        padding: 8px 15px;
        border-radius: 8px;
        font-weight: 600;
        transition: all 0.2s ease;
        text-decoration: none;
    }

        .btn-nav:hover {
            background: #e2e8f0;
            color: #1e293b;
        }

    /* Grid cho các ngày trong tuần */
    .schedule-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 25px;
    }

    .day-card {
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        border-top: 5px solid;
        transition: all 0.3s ease;
        padding: 20px;
    }

    .day-card-active {
        border-top-color: #10b981;
    }

    .day-card-inactive {
        border-top-color: #94a3b8;
    }

    .day-card-past {
        border-top-color: #fca5a5;
        opacity: 0.8;
    }
    /* Style cho ngày trong quá khứ */

    .day-header {
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 1px dashed #e2e8f0;
    }

        .day-header h5 {
            font-weight: 700;
            margin: 0;
            font-size: 1.1rem;
            color: #1e293b;
        }

        .day-header p {
            margin: 0;
            font-size: 0.85rem;
            color: #64748b;
        }

    .schedule-info {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 10px;
        font-size: 0.95rem;
        font-weight: 600;
    }

    .status-badge {
        font-size: 0.8rem;
        padding: 5px 10px;
        border-radius: 15px;
        font-weight: 700;
    }

    .bg-status-success {
        background: #d1fae5;
        color: #065f46;
    }

    .bg-status-warning {
        background: #fef3c7;
        color: #92400e;
    }

    .bg-status-secondary {
        background: #e2e8f0;
        color: #475569;
    }

    /* Form chỉnh sửa */
    .edit-form-wrapper {
        border-top: 1px solid #f1f5f9;
        padding-top: 15px;
        margin-top: 15px;
    }

    .time-input-group {
        display: flex;
        gap: 10px;
        margin-bottom: 10px;
    }

    .form-control-time {
        padding: 8px 10px;
        border: 1px solid #cbd5e1;
        border-radius: 6px;
        font-size: 0.9rem;
        width: 100%;
        box-sizing: border-box;
    }

    .action-buttons {
        display: flex;
        justify-content: flex-end;
        gap: 8px;
    }

        .action-buttons .btn:disabled {
            cursor: not-allowed;
            opacity: 0.6;
        }
</style>

<div class="schedule-container py-4">
    <h3 class="mb-4 text-primary"><i class="fas fa-calendar-alt me-2"></i> Quản lý Lịch Làm Việc</h3>

    @if (TempData["Error"] != null)
    {
        <div class="alert alert-danger mb-3"><i class="fas fa-exclamation-triangle me-2"></i> @TempData["Error"]</div>
    }
    @if (TempData["Success"] != null)
    {
        <div class="alert alert-success mb-3"><i class="fas fa-check-circle me-2"></i> @TempData["Success"]</div>
    }

    <div class="header-card">
        <h5 class="text-secondary">Tuần làm việc hiện tại:</h5>
        <h3 class="fw-bold text-dark">
            @weekStart.ToString("dd/MM/yyyy") — @weekEnd.ToString("dd/MM/yyyy")
        </h3>
        <div class="week-navigation">
            <a href="?weekStart=@weekStart.AddDays(-7).ToString("yyyy-MM-dd")" class="btn-nav">
                <i class="fas fa-chevron-left me-2"></i> Tuần trước
            </a>

            <a href="?weekStart=@weekStart.AddDays(7).ToString("yyyy-MM-dd")" class="btn-nav">
                Tuần sau <i class="fas fa-chevron-right ms-2"></i>
            </a>
            <a href="/Doctor/WorkSchedule" class="btn-nav" style="background: #e0f2f1; color: #00796b;">
                <i class="fas fa-calendar-day me-2"></i> Về tuần hiện tại
            </a>
        </div>

        @if (weekStart.Date < today.Date)
        {
            <div class="alert alert-warning mt-3 mb-0">
                <i class="fas fa-exclamation-triangle me-2"></i> Bạn đang xem lịch làm việc trong quá khứ. Không thể chỉnh sửa/thêm lịch.
            </div>
        }
    </div>

    <h4 class="mb-3 text-dark"><i class="fas fa-calendar-check me-2"></i> Chi tiết Lịch trình</h4>
    <div class="schedule-grid">
        @for (int i = 0; i < 7; i++)
        {
            var day = weekStart.AddDays(i);
            var schedule = Model.FirstOrDefault(x => x.NgayLamViec.Date == day.Date);

            // XÁC ĐỊNH RÀNG BUỘC THỜI GIAN
            bool isPastDay = day.Date < today.Date;

            // Thiết lập giá trị mặc định cho form
            string defaultStartTime = schedule != null ? schedule.GioBatDau.ToString(@"hh\:mm") : "08:00";
            string defaultEndTime = schedule != null ? schedule.GioKetThuc.ToString(@"hh\:mm") : "17:00";

            string statusText = "Nghỉ";
            string statusClass = "bg-status-secondary";
            string cardClass = isPastDay ? "day-card-past" : "day-card-inactive"; // Thêm class past
            string timeRange = "Không có lịch làm việc";
            bool isActive = false;

            if (schedule != null)
            {
                timeRange = $"{schedule.GioBatDau.ToString(@"hh\:mm")} - {schedule.GioKetThuc.ToString(@"hh\:mm")}";
                statusText = schedule.TrangThai == "Đã xác nhận" ? "Hoạt động" : "Chờ duyệt";
                statusClass = schedule.TrangThai == "Đã xác nhận" ? "bg-status-success" : "bg-status-warning";
                cardClass = isPastDay ? "day-card-past" : (schedule.TrangThai == "Đã xác nhận" ? "day-card-active" : "day-card-inactive");
                isActive = true;
            }

            <div class="day-card @cardClass">
                <div class="day-header">
                    <h5>@GetDayOfWeekName(day) @(day.Date == today.Date ? "(Hôm nay)" : "")</h5>
                    <p>@day.ToString("dd/MM/yyyy")</p>
                </div>

                <div class="schedule-info">
                    <i class="fas fa-clock text-info"></i>
                    <span>@timeRange</span>
                </div>
                <div class="schedule-info">
                    <i class="fas fa-check-circle text-primary"></i>
                    <span class="status-badge @statusClass">@statusText</span>
                </div>

                <div class="edit-form-wrapper">
                    <h6 class="text-dark fw-bold mb-3">Chỉnh sửa Lịch làm việc</h6>
                    <form method="post" asp-action="UpdateWorkSchedule" asp-controller="Doctor">

                        <div class="time-input-group">
                            <input type="time" name="GioBatDau" value="@defaultStartTime" required class="form-control-time" style="width: 50%;" title="Giờ Bắt đầu" @(isPastDay ? "disabled" : "") />
                            <input type="time" name="GioKetThuc" value="@defaultEndTime" required class="form-control-time" style="width: 50%;" title="Giờ Kết thúc" @(isPastDay ? "disabled" : "") />
                        </div>

                        <div class="action-buttons">
                            <input type="hidden" name="Id" value="@(schedule != null ? schedule.MaLich : 0)" />
                            <input type="hidden" name="Ngay" value="@day.ToString("yyyy-MM-dd")" />

                            @if (isPastDay)
                            {
                                <span class="text-danger small fst-italic">Không thể chỉnh sửa lịch đã qua.</span>
                            }
                            else if (isActive)
                            {
                                <button type="submit" name="actionType" value="update" class="btn btn-primary btn-sm" title="Cập nhật">
                                    <i class="fas fa-edit"></i> Sửa
                                </button>
                                <button type="submit" name="actionType" value="delete" class="btn btn-danger btn-sm" onclick="return confirm('Bạn có chắc muốn xóa lịch làm việc này?');" title="Xóa lịch">
                                    <i class="fas fa-trash-alt"></i> Xóa
                                </button>
                            }
                            else
                            {
                                <button type="submit" name="actionType" value="add" class="btn btn-success btn-sm w-100" title="Thêm mới">
                                    <i class="fas fa-plus"></i> Đăng ký lịch
                                </button>
                            }
                        </div>
                    </form>
                </div>
            </div>
        }
    </div>
</div>