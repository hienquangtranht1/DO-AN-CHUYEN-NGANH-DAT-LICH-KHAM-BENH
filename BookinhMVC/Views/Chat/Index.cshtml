@model IEnumerable<BookinhMVC.Models.CsKh>
@{
    ViewData["Title"] = "Hỗ trợ trực tuyến";
}

<div class="container py-4">
    <div class="row">
        <div class="col-md-4 mb-3">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <i class="fas fa-headset me-2"></i> Chọn nhân viên hỗ trợ
                </div>
                <div class="list-group list-group-flush">
                    @foreach (var item in Model)
                    {
                        <button class="list-group-item list-group-item-action d-flex justify-content-between align-items-center btn-connect"
                                data-id="@item.Id" data-name="@item.FullName">
                            @item.FullName
                            <span class="badge bg-success rounded-pill">Online</span>
                        </button>
                    }
                </div>
            </div>
        </div>

        <div class="col-md-8">
            <div id="waitingScreen" style="display:none;" class="alert alert-warning text-center">
                <div class="spinner-border spinner-border-sm text-warning me-2"></div>
                Đang gửi yêu cầu kết nối tới <strong id="targetName">...</strong>. Vui lòng đợi...
            </div>

            <div id="chatInterface" style="display:none;" class="card shadow-sm">
                <div class="card-header bg-info text-white d-flex justify-content-between">
                    <span>Chat với: <strong id="chatWithName">...</strong></span>
                    <button class="btn btn-sm btn-danger" onclick="location.reload()">Kết thúc</button>
                </div>

                <div class="card-body bg-light" id="msgContainer" style="height: 400px; overflow-y: auto;">
                </div>

                <div class="card-footer">
                    <div class="input-group">
                        <input type="text" id="txtMessage" class="form-control" placeholder="Nhập tin nhắn..." autocomplete="off">
                        <button class="btn btn-primary" id="btnSend"><i class="fas fa-paper-plane"></i> Gửi</button>
                    </div>
                </div>
            </div>

            <div id="defaultScreen" class="text-center text-muted mt-5">
                <i class="fas fa-comments fa-3x mb-3"></i>
                <h5>Vui lòng chọn một nhân viên để bắt đầu chat</h5>
            </div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/6.0.1/signalr.js"></script>

<script>
    // 1. Khởi tạo SignalR
    const connection = new signalR.HubConnectionBuilder().withUrl("/chatHub").build();
    let currentReceiverSignalRId = ""; // Lưu ID người nhận (VD: CSKH_2)
    let currentReceiverDbId = 0;

    connection.start().then(() => console.log("SignalR Connected"));

    // 2. Xử lý khi bấm chọn CSKH
    $('.btn-connect').click(function() {
        const cskhId = $(this).data('id');
        const cskhName = $(this).data('name');

        currentReceiverDbId = cskhId;
        currentReceiverSignalRId = "CSKH_" + cskhId;

        $('#defaultScreen').hide();
        $('#chatInterface').hide();
        $('#waitingScreen').show();
        $('#targetName').text(cskhName);
        $('#chatWithName').text(cskhName);

        // Gửi yêu cầu lên server
        connection.invoke("RequestChat", cskhId);
    });

    // 3. Khi CSKH chấp nhận
    connection.on("ChatAccepted", function() {
        $('#waitingScreen').hide();
        $('#chatInterface').show();
        loadHistory(); // Tải tin nhắn cũ
    });

    // 4. Gửi tin nhắn
    $('#btnSend').click(sendMessage);
    $('#txtMessage').keypress(function(e) { if(e.which == 13) sendMessage(); });

    function sendMessage() {
        const msg = $('#txtMessage').val().trim();
        if (!msg) return;

        // Gửi qua SignalR
        connection.invoke("SendMessage", currentReceiverSignalRId, msg);

        // Hiện tin nhắn của mình
        appendMessage(msg, true);
        $('#txtMessage').val('');
    }

    // 5. Nhận tin nhắn từ CSKH
    connection.on("ReceiveMessage", function(senderId, msg) {
        if (senderId === currentReceiverSignalRId) {
            appendMessage(msg, false);
        }
    });

    // Hàm phụ trợ
    function appendMessage(msg, isMe) {
        const align = isMe ? "text-end" : "text-start";
        const color = isMe ? "bg-primary text-white" : "bg-white border";
        const html = `
            <div class="${align} mb-2">
                <div class="d-inline-block p-2 rounded ${color}" style="max-width: 75%;">
                    ${msg}
                </div>
            </div>`;
        $('#msgContainer').append(html);
        $('#msgContainer').scrollTop($('#msgContainer')[0].scrollHeight);
    }

    function loadHistory() {
        $('#msgContainer').empty();
        $.get('/Chat/GetHistory?cskhId=' + currentReceiverDbId, function(data) {
            data.forEach(m => appendMessage(m.message, m.isMe));
        });
    }
</script>