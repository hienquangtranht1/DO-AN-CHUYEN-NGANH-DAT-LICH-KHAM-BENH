@model List<BookinhMVC.Models.AppointmentViewModel>
@{
    Layout = "~/Views/Shared/_DoctorLayout.cshtml";
    ViewBag.Title = "Qu·∫£n l√Ω l·ªãch h·∫πn";
    var request = Context.Request;

    string defaultDate = request.Query["date"];
    if (string.IsNullOrEmpty(defaultDate)) { defaultDate = DateTime.Today.ToString("yyyy-MM-dd"); }

    DateTime selectedDate;
    if (!DateTime.TryParse(defaultDate, out selectedDate)) { selectedDate = DateTime.Today; }

    var actualStartTime = (TimeSpan)(ViewData["ActualStartTime"] ?? new TimeSpan(7, 0, 0));
    var actualEndTime = (TimeSpan)(ViewData["ActualEndTime"] ?? new TimeSpan(18, 0, 0));
    var hasSchedule = (bool)(ViewData["HasSchedule"] ?? false);

    if (!hasSchedule && Model.Count == 0)
    {
        actualStartTime = new TimeSpan(7, 0, 0);
        actualEndTime = new TimeSpan(7, 30, 0);
    }

    var interval = TimeSpan.FromMinutes(30);
    var timeSlots = new List<TimeSpan>();
    for (var time = actualStartTime; time < actualEndTime; time = time.Add(interval))
    {
        timeSlots.Add(time);
    }
}

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" />

<style>
    .appointments-container {
        max-width: 1400px;
        margin: 0 auto;
    }

    .page-header {
        background: white;
        padding: 24px;
        border-radius: 16px;
        margin-bottom: 24px;
        border-left: 5px solid #0ea5e9;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }

    .appointment-card {
        position: absolute;
        width: calc(100% - 20px);
        border-radius: 8px;
        padding: 5px 8px;
        z-index: 10;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    .status-confirmed-card {
        background-color: #dbeafe;
        border-left: 4px solid #0ea5e9;
    }

    .status-pending-card {
        background-color: #fef3c7;
        border-left: 4px solid #f59e0b;
    }

    .status-cancelled-card {
        background-color: #f1f5f9;
        border-left: 4px solid #94a3b8;
    }
    /* ... C√°c class CSS kh√°c c·ªßa b·∫°n gi·ªØ nguy√™n ... */
    .time-grid-container {
        display: grid;
        grid-template-columns: 80px 1fr;
        background: white;
        border-radius: 16px;
        border: 1px solid #e2e8f0;
    }

    .time-label-slot, .appointment-slot {
        height: 60px;
        border-bottom: 1px dashed #e2e8f0;
    }

    .appointment-area {
        position: relative;
        padding: 0 10px;
    }

    .appointment-wrapper {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        padding: 10px;
    }
</style>

<div class="appointments-container">
    <div class="page-header">
        <h2><i class="fas fa-calendar-alt"></i> L·ªãch h·∫πn ng√†y @selectedDate.ToString("dd/MM/yyyy")</h2>
    </div>

    <div class="filter-card" style="background:white; padding:20px; border-radius:16px; margin-bottom:20px;">
        <form method="get" class="filter-form" style="display:flex; gap:10px; align-items:end;">
            <div>
                <label>Ch·ªçn ng√†y</label>
                <input type="date" name="date" class="form-control" value="@selectedDate.ToString("yyyy-MM-dd")" />
            </div>
            <button type="submit" class="btn btn-primary"><i class="fas fa-search"></i> Xem l·ªãch</button>
            <a href="/Doctor/Appointments" class="btn btn-secondary"><i class="fas fa-redo"></i> H√¥m nay</a>
        </form>
    </div>

    <div class="time-grid-container">
        <div class="time-labels">
            @foreach (var time in timeSlots)
            {
                <div class="time-label-slot" style="text-align:right; padding-right:10px; line-height:60px;">@time.ToString(@"hh\:mm")</div>
            }
        </div>

        <div class="appointment-area">
            @foreach (var time in timeSlots)
            {
                <div class="appointment-slot"></div>
            }

            <div class="appointment-wrapper">
                @foreach (var item in Model)
                {
                    if (item.NgayGio.TimeOfDay >= actualStartTime && item.NgayGio.TimeOfDay < actualEndTime)
                    {
                        var statusClass = item.TrangThai switch { "ƒê√£ x√°c nh·∫≠n" => "status-confirmed-card", "ƒê√£ h·ªßy" => "status-cancelled-card", _ => "status-pending-card" };
                        double top = (item.NgayGio.TimeOfDay - actualStartTime).TotalMinutes / 30 * 60;

                        <div class="appointment-card @statusClass" style="top: @(top)px; height: 60px;">
                            <div style="display:flex; justify-content:space-between;">
                                <strong>@item.NgayGio.ToString("HH:mm") | @item.HoTenBenhNhan</strong>
                                <span class="badge bg-secondary">@item.TrangThai</span>
                            </div>
                            <div style="display:flex; justify-content:space-between; margin-top:5px;">
                                <small>@item.TrieuChung</small>
                                <form method="post" asp-action="UpdateAppointment" asp-controller="Doctor" style="display:inline;">
                                    <input type="hidden" name="id" value="@item.MaLich" />
                                    <button type="submit" name="status" value="ƒê√£ x√°c nh·∫≠n" class="btn btn-sm btn-success py-0">‚úî</button>
                                    <button type="submit" name="status" value="ƒê√£ h·ªßy" class="btn btn-sm btn-danger py-0">‚úï</button>
                                </form>
                            </div>
                        </div>
                    }
                }
            </div>
        </div>
    </div>
</div>
@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/6.0.1/signalr.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>

    <script>
        // B√¢y gi·ªù $ ƒë√£ ƒë∆∞·ª£c ƒë·ªãnh nghƒ©a nh·ªù d√≤ng script tr√™n
        $(document).ready(function () {
            var doctorId = '@(Context.Session.GetInt32("DoctorId")?.ToString() ?? "")';
            var viewingDate = '@selectedDate.ToString("yyyy-MM-dd")';

            console.log("DoctorID:", doctorId);

            if (!doctorId) {
                console.error("‚ùå ERROR: DoctorId is missing.");
                return;
            }

            // ... (Ph·∫ßn code SignalR k·∫øt n·ªëi gi·ªØ nguy√™n nh∆∞ c≈©) ...
            var connection = new signalR.HubConnectionBuilder()
                .withUrl("/bookingHub?userId=" + doctorId + "&role=BacSi")
                .withAutomaticReconnect()
                .build();

            connection.on("ReceiveNewBooking", function (data) {
                toastr.success(data.noiDung, "üìÖ L·ªãch h·∫πn m·ªõi!");
                var bookingDate = data.ngayGio.substring(0, 10);
                if (bookingDate === viewingDate) {
                    setTimeout(function() { location.reload(); }, 1500);
                }
            });

            connection.on("ReceiveStatusChange", function (data) {
                if (data.trangThaiMoi === "ƒê√£ h·ªßy") {
                    toastr.error("L·ªãch h·∫πn #" + data.maLich + " ƒë√£ b·ªã h·ªßy.", "ƒê√£ h·ªßy");
                    setTimeout(function() { location.reload(); }, 1500);
                }
            });

            connection.start()
                .then(function () {
                    console.log("‚úÖ K·∫æT N·ªêI TH√ÄNH C√îNG!");
                })
                .catch(function (err) {
                    console.error("‚ùå L·ªñI K·∫æT N·ªêI: " + err.toString());
                });
        });
    </script>
}