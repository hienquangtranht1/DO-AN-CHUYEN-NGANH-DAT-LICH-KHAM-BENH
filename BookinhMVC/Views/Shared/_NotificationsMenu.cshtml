@model List<BookinhMVC.Models.ThongBao>
@{
    Layout = "~/Views/Shared/_Layout.cshtml";
    ViewBag.Title = "Thông báo của tôi";
}

<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 class="mb-0">Thông báo</h2>
        <div>
            <button id="markAllReadBtn" class="btn btn-sm btn-outline-primary">Đánh dấu đã đọc tất cả</button>
        </div>
    </div>

    <div id="notificationsList">
        @if (Model != null && Model.Any())
        {
            <div class="list-group">
                @foreach (var t in Model)
                {
                    <a href="javascript:void(0)" class="list-group-item list-group-item-action notification-item @(t.DaXem ? "" : "bg-light fw-bold")" data-id="@t.MaThongBao" data-appointment="@t.MaLichHen">
                        <div class="d-flex w-100 justify-content-between">
                            <h6 class="mb-1">@t.TieuDe</h6>
                            <small class="text-muted">@t.NgayTao.ToString("dd/MM/yyyy HH:mm")</small>
                        </div>
                        <p class="mb-1">@t.NoiDung</p>
                        @if (t.MaLichHen != null)
                        {
                            <small class="text-muted">Liên quan đến lịch: @t.MaLichHen</small>
                        }
                    </a>
                }
            </div>
        }
        else
        {
            <div class="alert alert-secondary">Bạn chưa có thông báo nào.</div>
        }
    </div>
</div>

@section Scripts {
    <script>
        (function () {
            async function markRead(id, navigateAppointmentId) {
                try {
                    await fetch('/User/Notifications/MarkRead', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ id: id })
                    });
                    // update UI
                    const el = document.querySelector('.notification-item[data-id="' + id + '"]');
                    if (el) el.classList.remove('fw-bold', 'bg-light');
                    if (navigateAppointmentId) {
                        // example: navigate to appointment detail page
                        window.location.href = '/Admin/AppointmentDetails/' + navigateAppointmentId;
                    }
                } catch (err) {
                    console.error(err);
                }
            }

            async function markAllRead() {
                try {
                    await fetch('/User/Notifications/MarkAllRead', { method: 'POST' });
                    document.querySelectorAll('.notification-item').forEach(e => e.classList.remove('fw-bold','bg-light'));
                    // update top bar badge if present
                    const badge = document.querySelector('#notif-badge');
                    if (badge) badge.textContent = '0';
                } catch (err) {
                    console.error(err);
                }
            }

            document.addEventListener('DOMContentLoaded', function () {
                document.getElementById('markAllReadBtn')?.addEventListener('click', function () {
                    markAllRead();
                });

                document.querySelectorAll('.notification-item').forEach(item => {
                    item.addEventListener('click', function () {
                        const id = this.getAttribute('data-id');
                        const appt = this.getAttribute('data-appointment');
                        markRead(id, appt);
                    });
                });
            });
        })();
    </script>
}@* Place this partial in the site header (e.g. in _Layout.cshtml nav) *@
<div class="nav-item dropdown me-3" id="notificationsMenu">
    <a class="nav-link position-relative dropdown-toggle" href="#" id="notificationsDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
        <i class="fas fa-bell fa-lg"></i>
        <span id="notif-badge" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" style="font-size:0.7rem;">0</span>
    </a>
    <ul class="dropdown-menu dropdown-menu-end p-2" aria-labelledby="notificationsDropdown" style="min-width:320px;">
        <li class="px-2"><strong>Thông báo mới</strong></li>
        <li><hr class="dropdown-divider" /></li>
        <li id="notif-items-container" style="max-height:300px; overflow:auto;">
            <div class="text-center text-muted py-3">Đang tải...</div>
        </li>
        <li><hr class="dropdown-divider" /></li>
        <li class="px-2">
            <a href="/User/Notifications" class="btn btn-sm btn-outline-primary w-100">Xem tất cả</a>
        </li>
    </ul>
</div>

@section Scripts {
<script>
    (function () {
        const badgeEl = document.getElementById('notif-badge');
        const container = document.getElementById('notif-items-container');

        async function loadCount() {
            try {
                const res = await fetch('/User/Notifications/Count');
                const json = await res.json();
                if (json.success) {
                    badgeEl.textContent = json.unread > 0 ? json.unread : '0';
                    badgeEl.style.display = json.unread > 0 ? 'inline-block' : 'none';
                }
            } catch (e) {
                console.error('notif count', e);
            }
        }

        async function loadPreview() {
            try {
                const res = await fetch('/User/Notifications/List?take=6');
                const json = await res.json();
                if (!json.success) {
                    container.innerHTML = '<div class="px-3 py-2 text-muted">Không thể tải thông báo.</div>';
                    return;
                }
                const items = json.data;
                if (!items || items.length === 0) {
                    container.innerHTML = '<div class="px-3 py-2 text-muted">Không có thông báo mới.</div>';
                    return;
                }

                container.innerHTML = '';
                items.forEach(it => {
                    const a = document.createElement('a');
                    a.href = 'javascript:void(0)';
                    a.className = 'dropdown-item d-flex align-items-start justify-content-between';
                    a.setAttribute('data-id', it.id);
                    a.innerHTML = `<div><div class="small">${it.title}</div><div class="text-muted small">${it.content}</div></div>
                                   <small class="text-muted">${new Date(it.createdAt).toLocaleString()}</small>`;
                    a.addEventListener('click', async () => {
                        // mark read and optionally navigate to related appointment
                        await fetch('/User/Notifications/MarkRead', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ id: it.id })
                        });
                        // reduce badge
                        const current = parseInt(badgeEl.textContent || '0');
                        if (current > 0) badgeEl.textContent = (current - 1).toString();
                        if (it.relatedAppointmentId) {
                            window.location.href = '/Admin/AppointmentDetails/' + it.relatedAppointmentId;
                        } else {
                            // optionally refresh preview
                            loadPreview();
                        }
                    });
                    container.appendChild(a);
                });

            } catch (e) {
                console.error('notif list', e);
                container.innerHTML = '<div class="px-3 py-2 text-muted">Lỗi tải thông báo.</div>';
            }
        }

        document.addEventListener('DOMContentLoaded', function () {
            loadCount();
            loadPreview();
            // poll every 30s
            setInterval(loadCount, 30000);
        });
    })();
</script>
}