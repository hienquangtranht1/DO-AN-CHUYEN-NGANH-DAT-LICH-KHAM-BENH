@{
    ViewData["Title"] = "Thanh toán Dịch vụ - Quét mã QR";
    Layout = "~/Views/Shared/_Layout.cshtml";

    // Lấy dữ liệu từ Controller truyền sang
    var bankId = ViewBag.BankId;         // Vd: TCB
    var accountNo = ViewBag.AccountNo;   // Vd: 1907...
    var accountName = ViewBag.AccountName; // Vd: TRAN QUANG HIEN
    var amount = ViewBag.Amount;         // Vd: 50000
    var content = ViewBag.Content;       // Mã tham chiếu (unique code)
    var transId = ViewBag.TransId;       // ID trong database để check status
    var orderInfo = ViewBag.OrderInfo;   // Nội dung hiển thị

    // Tạo link QR Code VietQR (Tự động điền số tiền và nội dung)
    var qrUrl = $"https://img.vietqr.io/image/{bankId}-{accountNo}-compact2.jpg?amount={amount}&addInfo={content}&accountName={accountName}";
}

<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-md-8 col-lg-5">
            <div class="card border-0 shadow-lg rounded-4 overflow-hidden">

                @* HEADER CARD *@
                <div class="card-header bg-primary text-white text-center py-4">
                    <h4 class="mb-0 fw-bold"><i class="fas fa-qrcode me-2"></i>Thanh toán Dịch vụ</h4>
                    <p class="mb-0 opacity-75">Quét mã QR để hoàn tất thanh toán</p>
                </div>

                <div class="card-body p-4 text-center">

                    @* THÔNG BÁO *@
                    <div class="alert alert-warning border-warning bg-light-warning mb-4 small">
                        <i class="fas fa-info-circle me-1"></i>
                        Vui lòng không sửa nội dung chuyển khoản để hệ thống tự động xác nhận.
                    </div>

                    @* KHU VỰC HIỂN THỊ MÃ QR *@
                    <div class="qr-container mb-4 position-relative d-inline-block">
                        <div class="card border p-2 rounded-3 shadow-sm">
                            <img src="@qrUrl" alt="QR Code VietQR" class="img-fluid" style="max-width: 100%; width: 280px;" />
                        </div>
                        @* Loading spinner trang trí *@
                        <div class="position-absolute top-100 start-50 translate-middle mt-3">
                            <span class="badge bg-white text-primary border border-primary px-3 py-2 rounded-pill shadow-sm">
                                <span class="spinner-grow spinner-grow-sm me-1" role="status" aria-hidden="true"></span>
                                Đang chờ thanh toán...
                            </span>
                        </div>
                    </div>

                    <div class="mt-5"></div>

                    @* CHI TIẾT GIAO DỊCH *@
                    <div class="payment-details text-start bg-light p-3 rounded-3 mb-4 border">
                        <div class="d-flex justify-content-between mb-2 pb-2 border-bottom">
                            <span class="text-muted small">Chủ tài khoản:</span>
                            <span class="fw-bold text-uppercase text-dark">@accountName</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2 pb-2 border-bottom">
                            <span class="text-muted small">Số tài khoản:</span>
                            <span class="fw-bold text-primary copy-text" role="button" onclick="copyToClipboard('@accountNo')" title="Sao chép">
                                @accountNo <i class="far fa-copy ms-1 text-secondary"></i>
                            </span>
                        </div>
                        <div class="d-flex justify-content-between mb-2 pb-2 border-bottom">
                            <span class="text-muted small">Số tiền:</span>
                            <span class="fw-bold text-danger fs-5">@string.Format("{0:N0}", amount) đ</span>
                        </div>
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="text-muted small">Nội dung CK:</span>
                            <span class="fw-bold text-success bg-white border border-success px-2 py-1 rounded copy-text" role="button" onclick="copyToClipboard('@content')" title="Sao chép">
                                @content <i class="far fa-copy ms-1"></i>
                            </span>
                        </div>
                    </div>

                    @* NÚT ĐIỀU HƯỚNG *@
                    <div class="d-grid gap-2">
                        <button class="btn btn-secondary disabled" id="status-btn" type="button">
                            <i class="fas fa-sync fa-spin me-2"></i>Hệ thống đang kiểm tra giao dịch...
                        </button>
                        <a href="/Home/QA" class="btn btn-link text-decoration-none text-muted btn-sm mt-2">
                            <i class="fas fa-arrow-left me-1"></i>Quay lại trang Hỏi đáp
                        </a>
                    </div>
                </div>

                <div class="card-footer bg-light text-center py-3">
                    <small class="text-muted d-block">Giao dịch ID: #@transId</small>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        // 1. Hàm Copy vào clipboard
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(function() {
                const Toast = Swal.mixin({
                    toast: true,
                    position: 'top-end',
                    showConfirmButton: false,
                    timer: 2000,
                    timerProgressBar: true
                });
                Toast.fire({
                    icon: 'success',
                    title: 'Đã sao chép: ' + text
                });
            }, function(err) {
                console.error('Lỗi sao chép: ', err);
            });
        }

        // 2. Hàm kiểm tra trạng thái thanh toán (AJAX Polling)
        $(document).ready(function () {
            var transId = '@transId';
            var checkInterval = setInterval(function () {
                $.ajax({
                    url: '/Payment/CheckStatus',
                    type: 'GET',
                    data: { id: transId },
                    success: function (response) {
                        if (response.success) {
                            // Dừng kiểm tra
                            clearInterval(checkInterval);

                            // Đổi trạng thái nút
                            $('#status-btn').removeClass('btn-secondary disabled').addClass('btn-success')
                                .html('<i class="fas fa-check-circle me-2"></i>Thanh toán thành công!');

                            // Hiển thị thông báo và chuyển hướng
                            Swal.fire({
                                icon: 'success',
                                title: 'Thanh toán thành công!',
                                text: 'Bạn đã có thể đặt câu hỏi.',
                                confirmButtonText: 'Đặt câu hỏi ngay',
                                allowOutsideClick: false
                            }).then((result) => {
                                if (result.isConfirmed) {
                                    window.location.href = '/Home/QA';
                                }
                            });

                            // Tự động chuyển sau 3 giây nếu không bấm
                            setTimeout(function() {
                                window.location.href = '/Home/QA';
                            }, 3000);
                        }
                    },
                    error: function(err) {
                        console.log("Đang chờ thanh toán...");
                    }
                });
            }, 3000); // Kiểm tra mỗi 3 giây
        });
    </script>
}