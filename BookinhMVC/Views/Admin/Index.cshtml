@using Newtonsoft.Json
@using System.Linq

@{
    Layout = "_AdminLayout";
    ViewBag.Active = "Dashboard";
    ViewBag.Title = "Admin Dashboard";

    // Giá trị mẫu hoặc từ ViewBag
    var users = ViewBag.UserCount ?? 150;
    var doctors = ViewBag.DoctorCount ?? 25;
    var patients = ViewBag.PatientCount ?? 800;
    var departments = ViewBag.DepartmentCount ?? 12;
    var appointments = ViewBag.AppointmentCount ?? 350;
    var reviews = ViewBag.ReviewCount ?? 120;
}

<style>
    /* Card thống kê tùy chỉnh dựa trên layout */
    .stat-card {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 20px 25px;
        border-radius: 16px;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        position: relative;
        cursor: pointer;
        background-color: #ffffff;
    }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        /* Định nghĩa màu sắc cho card thống kê */
        .stat-card.stat-primary .stat-value, .stat-card.stat-primary .icon {
            color: #4f46e5;
        }

        .stat-card.stat-primary:after {
            background: #4f46e5;
        }

        .stat-card.stat-success .stat-value, .stat-card.stat-success .icon {
            color: #198754;
        }

        .stat-card.stat-success:after {
            background: #198754;
        }

        .stat-card.stat-warning .stat-value, .stat-card.stat-warning .icon {
            color: #ffc107;
        }

        .stat-card.stat-warning:after {
            background: #ffc107;
        }

        .stat-card.stat-info .stat-value, .stat-card.stat-info .icon {
            color: #0dcaf0;
        }

        .stat-card.stat-info:after {
            background: #0dcaf0;
        }

        .stat-card.stat-secondary .stat-value, .stat-card.stat-secondary .icon {
            color: #6c757d;
        }

        .stat-card.stat-secondary:after {
            background: #6c757d;
        }

        .stat-card.stat-danger .stat-value, .stat-card.stat-danger .icon {
            color: #dc3545;
        }

        .stat-card.stat-danger:after {
            background: #dc3545;
        }

        /* Hiệu ứng viền màu */
        .stat-card:after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 5px;
            border-radius: 16px 16px 0 0;
            transition: height 0.3s ease;
        }

        .stat-card:hover:after {
            height: 8px;
        }


        .stat-card .stat-content {
            order: 1;
            text-align: left;
            color: var(--text-primary);
            z-index: 10;
        }

        .stat-card .icon {
            order: 2;
            font-size: 3rem;
            opacity: 0.2; /* Làm mờ icon nền */
            margin-left: 10px;
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%) scale(1);
            transition: transform 0.3s ease, opacity 0.3s ease;
            z-index: 5;
        }

        .stat-card:hover .icon {
            transform: translateY(-50%) scale(1.1);
            opacity: 0.3;
        }

        .stat-card .stat-label {
            font-size: 0.9rem;
            margin-bottom: 0;
            opacity: 0.8;
            color: var(--text-secondary);
        }

        .stat-card .stat-value {
            font-weight: 800;
            font-size: 2.2rem;
            margin: 0;
            line-height: 1.1;
            transition: color 0.3s ease;
        }

    /* Biểu đồ */
    .chart-card {
        border: none;
        height: 100%;
        min-height: 450px; /* Chiều cao tối thiểu cho card biểu đồ */
    }

    .chart-container {
        position: relative;
        height: 350px; /* Chiều cao cố định cho canvas */
        width: 100%;
    }

    /* Tiêu đề */
    .dashboard-title {
        color: var(--primary-color) !important;
        text-shadow: 0 4px 8px rgba(79, 70, 229, 0.25);
        letter-spacing: 1px;
    }

    .chart-title {
        font-size: 1.25rem;
        border-bottom: 3px solid rgba(79, 70, 229, 0.1);
        padding-bottom: 10px;
    }

    /* Responsive */
    @@media (max-width: 1200px) {
        .col-lg-2

    {
        /* 6 cột trên màn hình desktop (3 thẻ/hàng) */
        flex: 0 0 auto;
        width: 33.333333%;
    }

    }

    @@media (max-width: 991.98px) {
        /* Màn hình tablet/nhỏ hơn - 3 thẻ/hàng */
        .col-4

    {
        width: 33.333333%;
        flex: 0 0 auto;
    }

    .chart-card {
        min-height: auto;
    }

    .chart-container {
        height: 300px;
    }

    .stat-card {
        padding: 15px 15px; /* Giảm padding */
    }

        .stat-card .stat-value {
            font-size: 1.5rem; /* Giảm cỡ chữ */
        }

        .stat-card .stat-label {
            font-size: 0.75rem; /* Giảm cỡ chữ */
        }

    }

    @@media (max-width: 576px) {
        /* Màn hình điện thoại - 3 thẻ/hàng */
        .col-4

    {
        width: 33.333333%;
    }

    .dashboard-title {
        font-size: 1.5rem;
        margin-bottom: 2rem !important;
    }

    .chart-container {
        height: 250px;
    }

    }
</style>

<div class="container-fluid py-4">
    <h2 class="fw-bolder mb-5 text-center dashboard-title animate__animated animate__fadeInDown">
        <i class="fas fa-tachometer-alt me-2"></i>Bảng Điều Khiển Quản Trị
    </h2>

    <div class="row g-4 mb-5 justify-content-center">
        <div class="col-4 col-md-4 col-lg-2">
            <div class="stat-card stat-primary">
                <div class="stat-content">
                    <h3 id="userCount" class="stat-value">@users</h3>
                    <h6 class="stat-label">Người dùng</h6>
                </div>
                <div class="icon"><i class="fas fa-users"></i></div>
            </div>
        </div>

        <div class="col-4 col-md-4 col-lg-2">
            <div class="stat-card stat-success">
                <div class="stat-content">
                    <h3 id="doctorCount" class="stat-value">@doctors</h3>
                    <h6 class="stat-label">Bác sĩ</h6>
                </div>
                <div class="icon"><i class="fas fa-user-md"></i></div>
            </div>
        </div>

        <div class="col-4 col-md-4 col-lg-2">
            <div class="stat-card stat-warning">
                <div class="stat-content">
                    <h3 id="patientCount" class="stat-value">@patients</h3>
                    <h6 class="stat-label">Bệnh nhân</h6>
                </div>
                <div class="icon"><i class="fas fa-hospital-user"></i></div>
            </div>
        </div>

        <div class="col-4 col-md-4 col-lg-2">
            <div class="stat-card stat-info">
                <div class="stat-content">
                    <h3 id="departmentCount" class="stat-value">@departments</h3>
                    <h6 class="stat-label">Khoa</h6>
                </div>
                <div class="icon"><i class="fas fa-building"></i></div>
            </div>
        </div>

        <div class="col-4 col-md-4 col-lg-2">
            <div class="stat-card stat-secondary">
                <div class="stat-content">
                    <h3 id="appointmentCount" class="stat-value">@appointments</h3>
                    <h6 class="stat-label">Lịch hẹn</h6>
                </div>
                <div class="icon"><i class="fas fa-calendar-check"></i></div>
            </div>
        </div>

        <div class="col-4 col-md-4 col-lg-2">
            <div class="stat-card stat-danger">
                <div class="stat-content">
                    <h3 id="reviewCount" class="stat-value">@reviews</h3>
                    <h6 class="stat-label">Đánh giá</h6>
                </div>
                <div class="icon"><i class="fas fa-star-half-alt"></i></div>
            </div>
        </div>
    </div>

    <div class="row g-4">
        <div class="col-lg-6">
            <div class="card shadow-lg rounded-4 chart-card">
                <div class="card-body p-4">
                    <h5 class="card-title text-center text-primary fw-bold mb-4 chart-title">
                        <i class="fas fa-chart-pie me-2"></i>Biểu đồ phân bổ dữ liệu
                    </h5>
                    <div class="chart-container">
                        <canvas id="pieChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-6">
            <div class="card shadow-lg rounded-4 chart-card">
                <div class="card-body p-4">
                    <h5 class="card-title text-center text-primary fw-bold mb-4 chart-title">
                        <i class="fas fa-chart-bar me-2"></i>Thống kê tổng hợp số lượng
                    </h5>
                    <div class="chart-container">
                        <canvas id="barChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        const stats = {
            users: @users,
            doctors: @doctors,
            patients: @patients,
            departments: @departments,
            appointments: @appointments,
            reviews: @reviews
        };

        // Sử dụng màu sắc từ Bootstrap nhưng điều chỉnh nhẹ
        const chartColors = {
            primary: '#4f46e5', // Màu chủ đạo của layout
            success: '#198754',
            warning: '#ffc107',
            info: '#0dcaf0',
            secondary: '#6c757d',
            danger: '#dc3545'
        };

        const chartLabels = ['Người dùng', 'Bác sĩ', 'Bệnh nhân', 'Khoa', 'Lịch hẹn', 'Đánh giá'];
        const chartData = [stats.users, stats.doctors, stats.patients, stats.departments, stats.appointments, stats.reviews];
        const chartBackgroundColors = [chartColors.primary, chartColors.success, chartColors.warning, chartColors.info, chartColors.secondary, chartColors.danger];

        // Pie Chart
        const pieCtx = document.getElementById('pieChart').getContext('2d');
        new Chart(pieCtx, {
            type: 'pie',
            data: {
                labels: chartLabels,
                datasets: [{
                    data: chartData,
                    backgroundColor: chartBackgroundColors,
                    borderColor: '#ffffff',
                    borderWidth: 2,
                    hoverOffset: 20
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 20,
                            font: {
                                size: 14
                            }
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed !== null) {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const value = context.parsed;
                                    const percentage = ((value / total) * 100).toFixed(1) + '%';
                                    label += `${value} (${percentage})`;
                                }
                                return label;
                            }
                        },
                        titleFont: { size: 14 },
                        bodyFont: { size: 14 },
                        padding: 10
                    }
                }
            }
        });

        // Bar Chart
        const barCtx = document.getElementById('barChart').getContext('2d');
        new Chart(barCtx, {
            type: 'bar',
            data: {
                labels: chartLabels,
                datasets: [{
                    label: 'Số lượng',
                    data: chartData,
                    backgroundColor: chartBackgroundColors.map(color => Chart.helpers.color(color).alpha(0.8).rgbString()),
                    borderColor: chartBackgroundColors,
                    borderWidth: 1,
                    borderRadius: 6,
                    hoverBackgroundColor: chartBackgroundColors,
                    borderSkipped: false
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: { mode: 'index', intersect: false }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            drawBorder: false,
                            color: 'rgba(0, 0, 0, 0.05)'
                        },
                        ticks: {
                            precision: 0,
                            font: { size: 12 }
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        },
                        ticks: {
                            font: { size: 12 }
                        }
                    }
                }
            }
        });
    </script>
}