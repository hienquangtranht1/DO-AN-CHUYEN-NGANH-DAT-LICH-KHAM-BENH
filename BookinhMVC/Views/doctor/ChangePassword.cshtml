@*
    Đổi mật khẩu cho bác sĩ với xác thực OTP qua email
*@
@{
    ViewData["Title"] = "Đổi mật khẩu bác sĩ";
    var message = TempData["cp_message"] as string;
    Layout = "~/Views/Shared/_DoctorLayout.cshtml";
}

<div class="container my-5 pt-5">
    <div class="change-password-card mx-auto col-lg-6 col-md-8 col-sm-10 p-4 p-md-5 rounded-4 shadow-lg bg-white">

        <h2 class="text-center mb-4 fw-bold text-primary">
            <i class="fas fa-key me-2"></i> Đổi Mật Khẩu Truy Cập
        </h2>
        <p class="text-center text-secondary mb-5">
            Vui lòng nhập mật khẩu cũ, mật khẩu mới và xác thực bằng mã OTP được gửi qua email của bạn.
        </p>

        @* HIỂN THỊ THÔNG BÁO TỪ TEMP DATA *@
        @if (TempData["cp_message"] != null)
        {
            var alertClass = TempData["cp_message"].ToString().Contains("thành công") ? "alert-success" : "alert-info";
            <div class="alert @alertClass mb-4" role="alert">
                @TempData["cp_message"]
            </div>
        }
        <div id="otpMessage"></div>

        <form id="changePasswordForm" asp-action="ChangePassword" asp-controller="Doctor" method="post" autocomplete="off" class="row g-4">

            <div class="col-12 form-group position-relative">
                <label for="oldPassword" class="form-label fw-medium">Mật khẩu cũ</label>
                <input type="password" name="oldPassword" id="oldPassword" class="form-control rounded-3 py-2" required />
                <i class="fa fa-eye toggle-password" data-target="#oldPassword"></i>
            </div>

            <div class="col-md-6 form-group position-relative">
                <label for="newPassword" class="form-label fw-medium">Mật khẩu mới</label>
                <input type="password" name="newPassword" id="newPassword" class="form-control rounded-3 py-2" required />
                <i class="fa fa-eye toggle-password" data-target="#newPassword"></i>
            </div>

            <div class="col-md-6 form-group position-relative">
                <label for="confirmPassword" class="form-label fw-medium">Xác nhận mật khẩu mới</label>
                <input type="password" name="confirmPassword" id="confirmPassword" class="form-control rounded-3 py-2" required />
                <i class="fa fa-eye toggle-password" data-target="#confirmPassword"></i>
            </div>

            <div class="col-12 d-flex align-items-center flex-wrap gap-2 pt-2">
                <div class="flex-grow-1">
                    <label for="verificationCode" class="form-label fw-medium mb-1">Mã xác thực OTP</label>
                    <input type="text" name="verificationCode" id="verificationCode" class="form-control rounded-3" style="max-width: 180px;" required disabled />
                </div>

                <div class="pt-3">
                    <button type="button" id="sendOtpBtn" class="btn btn-outline-primary fw-bold" style="min-width: 150px;">
                        <i class="fas fa-paper-plane me-1"></i> Gửi mã OTP
                    </button>
                </div>
            </div>

            <div class="col-12 text-center mt-4">
                <button type="submit" id="submitPasswordBtn" class="btn btn-primary btn-lg rounded-pill px-5 fw-bold" disabled>
                    <i class="fas fa-check-circle me-2"></i> Xác nhận đổi mật khẩu
                </button>
            </div>
        </form>
    </div>
</div>

<style>
    /* CSS CƠ SỞ */
    body {
        background-color: #f4f7f6; /* Nền nhẹ */
        font-family: 'Roboto', sans-serif;
    }

    .change-password-card {
        border: 1px solid #e9ecef;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.08);
    }

    .text-primary {
        color: #0d6efd !important;
    }

    .form-control {
        transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
    }

        .form-control:focus {
            border-color: #80bdff;
            box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
        }

    .toggle-password {
        cursor: pointer;
        position: absolute;
        right: 15px;
        top: 65%; /* Điều chỉnh căn giữa cho input */
        transform: translateY(-50%);
        color: #6c757d;
        z-index: 2;
    }

    .form-group input {
        padding-right: 40px !important;
    }

    .btn-primary {
        background-color: #0d6efd;
        border-color: #0d6efd;
    }

        .btn-primary:hover {
            background-color: #0b5ed7;
            border-color: #0a58ca;
        }

    .alert-success {
        background-color: #d1e7dd;
        border-color: #badbcc;
        color: #0f5132;
    }
</style>

@section Scripts {
    <script src="~/lib/jquery/dist/jquery.min.js"></script>
    <script src="~/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        $(function () {
            // Toggle password visibility
            $(".toggle-password").click(function () {
                var targetId = $(this).attr("data-target");
                var input = $(targetId);

                if (input.attr("type") === "password") {
                    input.attr("type", "text");
                    $(this).removeClass("fa-eye").addClass("fa-eye-slash");
                } else {
                    input.attr("type", "password");
                    $(this).removeClass("fa-eye-slash").addClass("fa-eye");
                }
            });

            // Validate password rules (min 8 chars, 1 upper, 1 lower, 1 digit)
            function validatePassword(password) {
                if (password.length < 8) return "Mật khẩu phải có ít nhất 8 ký tự";
                if (!/[A-Z]/.test(password)) return "Mật khẩu phải chứa ít nhất một chữ hoa (A-Z)";
                if (!/[a-z]/.test(password)) return "Mật khẩu phải chứa ít nhất một chữ thường (a-z)";
                if (!/[0-9]/.test(password)) return "Mật khẩu phải chứa ít nhất một chữ số (0-9)";
                return true;
            }

            // Gửi OTP qua AJAX
            $("#sendOtpBtn").click(function () {
                var oldPassword = $("#oldPassword").val().trim();
                var newPassword = $("#newPassword").val().trim();
                var confirmPassword = $("#confirmPassword").val().trim();

                var msg = "";
                // 1. Kiểm tra trường rỗng
                if (oldPassword === "" || newPassword === "" || confirmPassword === "") {
                    msg = "Vui lòng điền đầy đủ tất cả các trường mật khẩu.";
                }
                // 2. Kiểm tra khớp mật khẩu
                else if (newPassword !== confirmPassword) {
                    msg = "Mật khẩu mới và xác nhận không khớp.";
                }
                // 3. Kiểm tra quy tắc mật khẩu
                else {
                    var passwordValidation = validatePassword(newPassword);
                    if (passwordValidation !== true) msg = passwordValidation;
                }

                if (msg) {
                    $("#otpMessage").html('<div class="alert alert-danger">' + msg + '</div>');
                    return;
                }

                // Nếu Validation OK, gửi OTP
                $.ajax({
                    url: '@Url.Action("RequestChangePasswordOtp", "Doctor")', // Đổi tên action thành RequestChangePasswordOtp nếu đó là tên trong Controller
                    type: "POST",
                    beforeSend: function () {
                        $("#sendOtpBtn").prop("disabled", true).html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Đang gửi...');
                        $("#otpMessage").html("");
                    },
                    success: function (response) {
                        if (response.success) {
                            $("#otpMessage").html('<div class="alert alert-success"><i class="fas fa-envelope me-1"></i> Mã OTP đã được gửi đến email của bạn. Vui lòng kiểm tra email và nhập mã OTP để xác nhận đổi mật khẩu.</div>');
                            $("#verificationCode").prop("disabled", false).focus();
                            $("#submitPasswordBtn").prop("disabled", false);
                        } else {
                            $("#otpMessage").html('<div class="alert alert-danger"><i class="fas fa-exclamation-triangle me-1"></i> ' + response.message + '</div>');
                            $("#sendOtpBtn").prop("disabled", false).html('<i class="fas fa-paper-plane me-1"></i> Gửi mã OTP');
                        }
                    },
                    error: function () {
                        $("#otpMessage").html('<div class="alert alert-danger"><i class="fas fa-times-circle me-1"></i> Lỗi kết nối. Không thể gửi mã OTP.</div>');
                    },
                    complete: function () {
                        // Chỉ hoàn tác nút nếu không thành công (vì nếu thành công, nút submit sẽ được kích hoạt)
                        if (!$("#verificationCode").prop("disabled")) {
                             $("#sendOtpBtn").prop("disabled", true).text("Mã đã gửi");
                        } else {
                            $("#sendOtpBtn").prop("disabled", false).html('<i class="fas fa-paper-plane me-1"></i> Gửi mã OTP');
                        }
                    }
                });
            });

            // Chặn submit nếu chưa nhập OTP
            $("#changePasswordForm").submit(function (e) {
                if ($("#verificationCode").val().trim() === "" || $("#verificationCode").prop("disabled")) {
                    e.preventDefault();
                    $("#otpMessage").html('<div class="alert alert-danger">Vui lòng nhận và nhập mã OTP!</div>');
                    $("#sendOtpBtn").focus();
                    return false;
                }

                // Final validation check before full submit
                if ($("#newPassword").val().trim() !== $("#confirmPassword").val().trim()) {
                     e.preventDefault();
                     $("#otpMessage").html('<div class="alert alert-danger">Mật khẩu mới và xác nhận không khớp.</div>');
                     return false;
                }
            });
        });
    </script>
}