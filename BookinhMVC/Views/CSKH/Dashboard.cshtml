@model BookinhMVC.Models.CsKh
@{
    ViewData["Title"] = "CSKH Dashboard";
    Layout = "~/Views/Shared/_LayoutCSKH.cshtml";
    var customers = ViewBag.Customers as List<BookinhMVC.Models.NguoiDung>;
}

<style>
    .chat-layout {
        height: 100vh;
        overflow: hidden;
        background-color: #f5f7fb;
    }

    /* Sidebar */
    .sidebar-wrapper {
        background: #fff;
        border-right: 1px solid #eef2f6;
        display: flex;
        flex-direction: column;
        height: 100%;
    }

    .sidebar-header {
        padding: 20px;
        border-bottom: 1px solid #eef2f6;
    }

    .user-list-container {
        flex: 1;
        overflow-y: auto;
        padding: 10px;
    }

    .user-card {
        padding: 10px;
        border-radius: 10px;
        margin-bottom: 5px;
        cursor: pointer;
        transition: 0.2s;
        background: #fff;
        border: 1px solid transparent;
    }

        .user-card:hover {
            background-color: #f8f9fa;
        }

        .user-card.active {
            background-color: #eef5ff;
            border-left: 4px solid #0d6efd;
        }

        .user-card.request {
            background-color: #fff9e6;
            border-left: 4px solid #ffc107;
        }

    /* Main Chat */
    .chat-main {
        display: flex;
        flex-direction: column;
        height: 100%;
        background: #fff;
    }

    .chat-topbar {
        padding: 15px 20px;
        border-bottom: 1px solid #eef2f6;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .chat-content {
        flex: 1;
        padding: 20px;
        overflow-y: auto;
        background-color: #f5f7fb;
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    /* Bong bóng tin nhắn */
    .bubble {
        max-width: 70%;
        padding: 10px 15px;
        border-radius: 15px;
        font-size: 0.95rem;
        word-wrap: break-word;
    }

    .bubble-me {
        align-self: flex-end;
        background: #0d6efd;
        color: white;
        border-bottom-right-radius: 2px;
    }

    .bubble-guest {
        align-self: flex-start;
        background: #fff;
        border: 1px solid #eef2f6;
        border-bottom-left-radius: 2px;
        color: #333;
    }

    /* Input Area */
    .chat-input-wrapper {
        padding: 20px;
        background: #fff;
        border-top: 1px solid #eef2f6;
    }
</style>

<div class="row g-0 chat-layout">
    <div class="col-md-3 sidebar-wrapper">
        <div class="sidebar-header">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="m-0 fw-bold text-primary">CSKH Portal</h5>
                <form asp-action="Logout" method="post" class="d-inline">
                    @Html.AntiForgeryToken()
                    <button type="submit" class="btn btn-sm btn-outline-danger rounded-pill px-3" title="Đăng xuất">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </form>
            </div>

            <div class="d-flex align-items-center p-2 bg-light rounded border">
                <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-2" style="width:35px; height:35px;">
                    @Model.FullName.Substring(0, 1).ToUpper()
                </div>
                <div style="line-height: 1.2;">
                    <div class="fw-bold small">@Model.FullName</div>
                    <div id="connectionStatus" class="text-muted small" style="font-size: 0.75rem;">Đang kết nối...</div>
                </div>
            </div>
        </div>

        <div id="userList" class="user-list-container">
            @if (customers != null)
            {
                foreach (var cust in customers)
                {
                    <div class="user-card d-flex align-items-center"
                         id="user-@cust.MaNguoiDung"
                         onclick="openChat('KH_@cust.MaNguoiDung', '@cust.TenDangNhap', @cust.MaNguoiDung, this)">
                        <div class="bg-secondary text-white rounded-circle d-flex align-items-center justify-content-center me-2" style="width:40px; height:40px;">
                            @cust.TenDangNhap.Substring(0, 1).ToUpper()
                        </div>
                        <div class="flex-grow-1">
                            <div class="d-flex justify-content-between">
                                <h6 class="mb-0 fw-bold text-dark text-truncate" style="max-width: 120px;">@cust.TenDangNhap</h6>
                                <span class="badge bg-danger rounded-pill" id="badge-@cust.MaNguoiDung" style="display:none">1</span>
                            </div>
                            <small class="text-muted status-text">Lịch sử chat</small>
                        </div>
                    </div>
                }
            }
        </div>
    </div>

    <div class="col-md-9 chat-main">
        <div id="welcomeScreen" class="d-flex flex-column justify-content-center align-items-center h-100">
            <i class="fas fa-comments fa-4x text-muted opacity-25 mb-3"></i>
            <h4 class="text-dark">Xin chào, @Model.FullName</h4>
            <p class="text-muted">Chọn khách hàng để bắt đầu chat.</p>
        </div>

        <div id="chatInterface" class="d-none flex-column h-100">
            <div class="chat-topbar">
                <div class="d-flex align-items-center">
                    <div class="bg-info text-white rounded-circle d-flex align-items-center justify-content-center me-3" style="width:40px; height:40px;">KH</div>
                    <div>
                        <h6 class="m-0 fw-bold" id="currentChatName">...</h6>
                        <small id="chatStatusText" class="text-success fw-bold">Đang kết nối...</small>
                    </div>
                </div>
                <button class="btn btn-outline-danger btn-sm rounded-pill px-3" onclick="cskhCancelChat()">
                    <i class="fas fa-power-off me-1"></i> Kết thúc
                </button>
            </div>

            <div id="chatHistory" class="chat-content"></div>

            <div class="chat-input-wrapper">
                <div class="input-group">
                    <input type="text" id="msgInput" class="form-control form-control-lg border-0 bg-light"
                           placeholder="Nhập tin nhắn..." autocomplete="off" disabled>

                    <button class="btn btn-primary px-4" id="btnSend" type="button" disabled>
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/6.0.1/signalr.js"></script>
<script>
    const connection = new signalR.HubConnectionBuilder()
        .withUrl("/chatHub")
        .withAutomaticReconnect()
        .build();

    let currentGuestSignalRId = "";
    let currentGuestDbId = 0;

    // --- KẾT NỐI SIGNALR ---
    connection.start()
        .then(() => {
            console.log("✅ CSKH Connected");
            $('#connectionStatus').text("● Online").removeClass('text-muted').addClass('text-success');

            // Bật sự kiện click sau khi kết nối thành công
            $('#btnSend').off('click').on('click', sendMessage);
            $('#msgInput').off('keypress').on('keypress', function (e) {
                if (e.which === 13) sendMessage();
            });
        })
        .catch(err => {
            console.error(err);
            $('#connectionStatus').text("● Mất kết nối").addClass('text-danger');
        });

    // ===============================================
    // --- 1. SỰ KIỆN TỪ SERVER ---
    // ===============================================

    // Nhận yêu cầu kết nối
    connection.on("ReceiveChatRequest", function (guestSignalRId, guestName, guestDbId) {
        $(`#user-${guestDbId}`).remove(); // Xóa nếu đã có

        const html = `
            <div class="user-card request" id="user-${guestDbId}">
                <div class="d-flex align-items-center mb-2">
                    <div class="bg-warning text-dark rounded-circle d-flex align-items-center justify-content-center me-2" style="width:40px; height:40px;">
                        <i class="fas fa-bell"></i>
                    </div>
                    <div>
                        <h6 class="mb-0 fw-bold text-dark">${guestName}</h6>
                        <small class="text-dark fw-bold">Yêu cầu chat mới</small>
                    </div>
                </div>
                <div class="d-flex gap-2">
                    <button class="btn btn-sm btn-success flex-grow-1" onclick="acceptReq('${guestSignalRId}', '${guestName}', ${guestDbId})">Chấp nhận</button>
                    <button class="btn btn-sm btn-outline-danger" onclick="rejectReq('${guestSignalRId}', ${guestDbId})">Từ chối</button>
                </div>
            </div>`;
        $('#userList').prepend(html);
    });

    // Khách hàng hủy
    connection.on("ClientCancelled", function(guestDbId) {
        $(`#user-${guestDbId}`).remove();
        if (currentGuestDbId == guestDbId) {
            disableChat("Khách hàng đã hủy kết nối.");
        }
    });

    // Nhận tin nhắn (TỪ KHÁCH HÀNG)
    connection.on("ReceiveMessage", function (senderId, msg) {
        if (senderId === currentGuestSignalRId) {
            appendMessage(msg, false); // false = Tin nhắn của khách
        } else {
            const dbId = senderId.split('_')[1];
            $(`#badge-${dbId}`).show(); // Hiện badge thông báo
            const item = $(`#user-${dbId}`);
            if(item.length) $('#userList').prepend(item); // Đẩy lên đầu
        }
    });

    // ===============================================
    // --- 2. HÀNH ĐỘNG CỦA CSKH ---
    // ===============================================

    // Chấp nhận
    window.acceptReq = function(signalRId, name, dbId) {
        connection.invoke("AcceptChat", signalRId);

        // Cập nhật lại giao diện thẻ user
        const newItem = `
            <div class="user-card active" id="user-${dbId}" onclick="openChat('${signalRId}', '${name}', ${dbId}, this)">
                <div class="d-flex align-items-center">
                    <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-2" style="width:40px; height:40px;">
                        ${name.charAt(0)}
                    </div>
                    <div>
                        <h6 class="mb-0 fw-bold text-dark">${name}</h6>
                        <small class="text-success status-text">Đang chat</small>
                    </div>
                </div>
            </div>`;

        $(`#user-${dbId}`).replaceWith(newItem);
        openChat(signalRId, name, dbId, $(`#user-${dbId}`));
    };

    // Từ chối
    window.rejectReq = function(signalRId, dbId) {
        if(confirm("Từ chối yêu cầu này?")) {
            connection.invoke("RejectChat", signalRId);
            $(`#user-${dbId}`).remove();
        }
    };

    // Mở Chat
    window.openChat = function(signalRId, name, dbId, element) {
        currentGuestSignalRId = signalRId;
        currentGuestDbId = dbId;

        $('.user-card').removeClass('active');
        if(element) $(element).addClass('active');
        $(`#badge-${dbId}`).hide();

        $('#welcomeScreen').addClass('d-none');
        $('#chatInterface').removeClass('d-none').addClass('d-flex');
        $('#currentChatName').text(name);

        // MỞ KHÓA Ô CHAT
        $('#msgInput').prop('disabled', false).val('').focus();
        $('#btnSend').prop('disabled', false);
        $('#chatStatusText').html('<span class="text-success">● Đang kết nối</span>');

        loadHistory(dbId);
    };

    // Ngắt kết nối
    window.cskhCancelChat = function() {
        if(!currentGuestSignalRId) return;
        if(confirm("Kết thúc phiên chat này?")) {
            connection.invoke("RejectChat", currentGuestSignalRId);
            disableChat("Bạn đã kết thúc cuộc trò chuyện.");
            $(`#user-${currentGuestDbId}`).find('.status-text').text("Đã kết thúc").addClass('text-danger');
        }
    };

    // Khóa chat khi kết thúc
    function disableChat(msg) {
        $('#chatStatusText').html(`<span class="text-danger">${msg}</span>`);
        $('#msgInput').prop('disabled', true);
        $('#btnSend').prop('disabled', true);
        appendSystemMessage(msg);
    }

    // ===============================================
    // --- 3. GỬI TIN NHẮN (ĐÃ FIX LỖI) ---
    // ===============================================
    function sendMessage() {
        const input = $('#msgInput');
        const msg = input.val().trim();

        if (!msg) return;
        if (!currentGuestSignalRId) { alert("Chưa chọn khách hàng!"); return; }

        // Gửi lên Server
        connection.invoke("SendMessage", currentGuestSignalRId, msg)
            .catch(err => {
                console.error("Lỗi gửi:", err);
                appendSystemMessage("⚠️ Lỗi gửi tin nhắn.");
            });

        // Hiện tin nhắn của mình ngay lập tức (isMe = true)
        appendMessage(msg, true);
        input.val('').focus();
    }

    // ===============================================
    // --- 4. CÁC HÀM HIỂN THỊ TIN NHẮN (ĐÂY LÀ PHẦN BẠN THIẾU) ---
    // ===============================================

    // Hàm vẽ bong bóng tin nhắn
    function appendMessage(msg, isMe) {
        const cls = isMe ? 'bubble-me' : 'bubble-guest';
        // Tạo HTML
        const html = `<div class="bubble mb-2 ${cls}">${msg}</div>`;

        // Thêm vào khung chat
        $('#chatHistory').append(html);

        // Cuộn xuống dưới cùng
        scrollToBottom();
    }

    // Hàm vẽ thông báo hệ thống (VD: "Đã ngắt kết nối")
    function appendSystemMessage(msg) {
        const html = `<div class="text-center small text-muted my-2">-- ${msg} --</div>`;
        $('#chatHistory').append(html);
        scrollToBottom();
    }

    // Hàm cuộn khung chat xuống dưới cùng
    function scrollToBottom() {
        const d = $('#chatHistory');
        d.scrollTop(d[0].scrollHeight);
    }

    // Hàm tải lịch sử chat từ Server
    function loadHistory(customerId) {
        $('#chatHistory').html('<div class="text-center mt-5"><div class="spinner-border spinner-border-sm text-primary"></div></div>');

        // Gọi API CSKHController/GetHistory
        $.get(`/CSKH/GetHistory?customerId=${customerId}`, function(data) {
            $('#chatHistory').empty();
            if(data && data.length > 0) {
                // Duyệt qua từng tin nhắn và vẽ ra
                data.forEach(m => appendMessage(m.message, m.isMe));
            } else {
                $('#chatHistory').html('<div class="text-center text-muted mt-5 opacity-50">Bắt đầu cuộc trò chuyện mới</div>');
            }
            scrollToBottom();
        });
    }
</script>