@{
    ViewData["Title"] = "Thanh toán QR Code";
    Layout = "~/Views/Shared/_Layout.cshtml";

    // Xử lý encode URL cho an toàn
    var content = Uri.EscapeDataString(ViewBag.Content ?? "");
    var accName = Uri.EscapeDataString(ViewBag.AccountName ?? "");
    var bankId = ViewBag.BankId;
    var accNo = ViewBag.AccountNo;
    var amount = ViewBag.Amount;

    // Link tạo ảnh QR VietQR
    var qrUrl = $"https://img.vietqr.io/image/{bankId}-{accNo}-compact2.png?amount={amount}&addInfo={content}&accountName={accName}";
}

<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-md-5">
            <div class="card border-0 shadow-lg rounded-4 text-center overflow-hidden">
                <div class="card-header bg-danger text-white py-3">
                    <h5 class="mb-0 fw-bold"><i class="fas fa-qrcode me-2"></i>Quét mã để thanh toán</h5>
                </div>

                <div class="card-body p-4 bg-white">
                    <p class="text-muted small mb-3">Mở App ngân hàng của bạn (TCB, VCB, MB...) và quét mã bên dưới</p>

                    <div class="position-relative d-inline-block mb-3 p-2 border rounded bg-white shadow-sm">
                        <img src="@qrUrl" class="img-fluid rounded" style="width: 100%; max-width: 280px;" alt="QR Code" />

                        <div class="position-absolute top-50 start-50 translate-middle" id="loading-spinner" style="display:none;">
                            <div class="spinner-border text-primary" role="status"></div>
                        </div>
                    </div>

                    <div class="bg-light p-3 rounded text-start mb-3">
                        <div class="d-flex justify-content-between mb-2 border-bottom pb-2">
                            <span class="text-muted small">Ngân hàng:</span>
                            <span class="fw-bold text-danger">Techcombank (TCB)</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2 border-bottom pb-2">
                            <span class="text-muted small">Chủ tài khoản:</span>
                            <span class="fw-bold text-uppercase">@ViewBag.AccountName</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2 border-bottom pb-2">
                            <span class="text-muted small">Số tài khoản:</span>
                            <span class="fw-bold text-primary copy-text" role="button" onclick="copyToClipboard('@accNo')">
                                @accNo <i class="far fa-copy ms-1 text-muted small"></i>
                            </span>
                        </div>
                        <div class="d-flex justify-content-between mb-2 border-bottom pb-2">
                            <span class="text-muted small">Số tiền:</span>
                            <span class="fw-bold text-success fs-5">@Convert.ToDecimal(amount).ToString("N0") đ</span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span class="text-muted small">Nội dung CK:</span>
                            <span class="fw-bold text-danger copy-text" role="button" onclick="copyToClipboard('@ViewBag.Content')">
                                @ViewBag.Content <i class="far fa-copy ms-1 text-muted small"></i>
                            </span>
                        </div>
                    </div>

                    <div class="alert alert-warning small border-0 d-flex align-items-center">
                        <div class="spinner-grow spinner-grow-sm text-warning me-2" role="status"></div>
                        <div>Hệ thống đang chờ nhận tiền... Vui lòng không tắt trình duyệt.</div>
                    </div>

                    <a asp-action="Index" class="btn btn-link text-muted btn-sm">Quay lại / Hủy bỏ</a>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Copy text helper
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text);
            alert("Đã sao chép: " + text);
        }

        // AUTO CHECK STATUS LOGIC
        $(document).ready(function() {
            var transId = '@ViewBag.TransId';
            var checkInterval = setInterval(function() {

                // Gọi API kiểm tra
                $.ajax({
                    url: '/Payment/CheckStatus',
                    type: 'GET',
                    data: { id: transId },
                    success: function(response) {
                        if (response.success) {
                            clearInterval(checkInterval); // Dừng kiểm tra

                            // Chuyển hướng về trang lịch sử hoặc trang chủ
                            alert("Thanh toán thành công! Tiền đã vào ví.");
                            window.location.href = "/Payment/History";
                        }
                    }
                });

            }, 2000); // Kiểm tra mỗi 2 giây

            // Dừng sau 10 phút để tránh quá tải
            setTimeout(function() { clearInterval(checkInterval); }, 600000);
        });
    </script>
}