@* File: Views/User/VerifyOtp.cshtml *@
@{
    ViewData["Title"] = "Xác nhận OTP đăng ký";
    Layout = "~/Views/Shared/_Layout.cshtml"; // Giữ Layout hiện tại
}

<div class="container my-5 pt-5">
    <div class="row justify-content-center">
        <div class="col-md-6 col-lg-5" data-aos="fade-up">
            <div class="card shadow-lg p-4 p-md-5 rounded-4">
                <h2 class="text-center mb-4 fw-bold text-primary">
                    <i class="fas fa-lock me-2"></i> Xác nhận OTP đăng ký
                </h2>
                <p class="text-center text-secondary mb-4">Mã OTP (6 chữ số) đã được gửi đến địa chỉ email của bạn.</p>

                @if (!ViewData.ModelState.IsValid)
                {
                    <div class="alert alert-danger rounded-3">
                        <i class="fas fa-times-circle me-2"></i>
                        @foreach (var error in ViewData.ModelState.Values.SelectMany(v => v.Errors))
                        {
                            <div>@error.ErrorMessage</div>
                        }
                    </div>
                }

                <form asp-action="VerifyOtp" method="post" id="otpForm">
                    <div class="form-group mb-4">
                        <label for="otp" class="form-label fw-medium text-center d-block">Nhập mã OTP:</label>

                        
                        <div class="otp-input-group d-flex justify-content-center gap-2 mt-3" id="otpFields">
                            @for (int i = 0; i < 6; i++)
                            {
                                <input type="text"
                                       class="form-control text-center otp-input rounded-3"
                                       maxlength="1"
                                       data-index="@i"
                                       required
                                       style="width: 40px; height: 40px; font-size: 1.25rem;" />
                            }
                        </div>
                        
                        <input type="hidden" name="otp" id="hiddenOtp" required />
                    </div>

                    <button type="submit" class="btn btn-primary w-100 btn-lg rounded-pill fw-bold">
                        <i class="fas fa-check-circle me-2"></i> Xác nhận
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const inputs = document.querySelectorAll('.otp-input');
            const hiddenOtp = document.getElementById('hiddenOtp');
            const otpForm = document.getElementById('otpForm');

            // Hàm tự động tổng hợp OTP vào trường ẩn
            function updateHiddenOtp() {
                let otpValue = '';
                inputs.forEach(input => {
                    otpValue += input.value;
                });
                hiddenOtp.value = otpValue;
            }

            // Tự động chuyển focus và giới hạn 1 ký tự
            inputs.forEach((input, index) => {
                input.addEventListener('input', (e) => {
                    // Xóa bất kỳ ký tự không phải số
                    input.value = input.value.replace(/[^0-9]/g, '');

                    if (input.value.length === 1 && index < inputs.length - 1) {
                        inputs[index + 1].focus();
                    }
                    updateHiddenOtp();
                });

                // Xử lý phím Backspace/Delete
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Backspace' && input.value.length === 0 && index > 0) {
                        inputs[index - 1].focus();
                        inputs[index - 1].value = ''; // Xóa ký tự ở ô trước
                        e.preventDefault();
                    }
                    // Đảm bảo chỉ cho phép nhập số hoặc Backspace
                    if (!(/[0-9]/.test(e.key) || e.key === 'Backspace' || e.key === 'Delete' || e.key === 'ArrowLeft' || e.key === 'ArrowRight' || e.key === 'Tab')) {
                        if (e.key.length === 1) e.preventDefault(); // Ngăn chặn nhập ký tự khác
                    }
                });

                // Xử lý dán (Paste)
                input.addEventListener('paste', (e) => {
                    e.preventDefault();
                    const pasteData = (e.clipboardData || window.clipboardData).getData('text').trim();
                    if (pasteData.length > 0) {
                        // Chỉ lấy 6 ký tự số đầu tiên
                        const otpPaste = pasteData.replace(/[^0-9]/g, '').substring(0, inputs.length);
                        otpPaste.split('').forEach((char, i) => {
                            if (index + i < inputs.length) {
                                inputs[index + i].value = char;
                            }
                        });
                        // Di chuyển focus đến ô cuối cùng đã nhập
                        const lastInputIndex = Math.min(index + otpPaste.length - 1, inputs.length - 1);
                        if (lastInputIndex >= 0) {
                            inputs[lastInputIndex].focus();
                        }
                    }
                    updateHiddenOtp();
                });
            });

            // Kiểm tra trước khi gửi form
            otpForm.addEventListener('submit', (e) => {
                updateHiddenOtp();
                if (hiddenOtp.value.length !== inputs.length) {
                    alert('Vui lòng nhập đầy đủ mã OTP (6 chữ số).');
                    e.preventDefault();
                    inputs[0].focus();
                }
            });
        });
    </script>
}

<style>
    /* Custom styles for OTP fields */
    .otp-input-group .otp-input {
        border-color: #ced4da;
        transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
        font-weight: bold;
    }

        .otp-input-group .otp-input:focus {
            border-color: #80bdff;
            box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
        }
</style>