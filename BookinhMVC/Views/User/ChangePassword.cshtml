@* File: Views/User/ChangePassword.cshtml *@
@{
    ViewData["Title"] = "Đổi mật khẩu - Four Rock";
    var message = TempData["cp_message"] as string;
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container my-5 pt-5">
    <div class="password-change-container mx-auto col-lg-7 col-md-9 p-4 p-md-5 rounded-4 shadow-lg bg-white" data-aos="fade-up">

        <h2 class="text-center fw-bold text-primary display-6 mb-4">
            <i class="fas fa-lock me-2"></i> Đổi mật khẩu
        </h2>
        <p class="text-center text-secondary mb-4">Vui lòng nhập mật khẩu cũ và mật khẩu mới. Mã xác nhận (OTP) sẽ được gửi đến email của bạn.</p>

        @* Hiển thị thông báo (Thành công/Lỗi) *@
        @if (!string.IsNullOrEmpty(message))
        {
            // Tùy thuộc vào nội dung TempData, ta hiển thị thành công hoặc thất bại
            <div class="alert @(message.Contains("thành công") ? "alert-success" : "alert-danger") rounded-3">
                <i class="fas fa-info-circle me-2"></i>@message
            </div>
        }

        @* Container hiển thị thông báo OTP đã gửi *@
        <div class="otp-container p-3 mb-4 rounded-3 border border-info bg-light" id="otpContainer" style="display:none;">
            <p class="mb-2 fw-medium text-dark"><i class="fas fa-envelope-open-text text-info me-2"></i> Mã xác nhận đã được gửi đến email của bạn.</p>
            <div class="otp-box bg-white fw-bold text-info border border-secondary mx-auto">******</div>
            <p class="text-muted small mt-2">Mã OTP có hiệu lực trong 5 phút. Vui lòng kiểm tra hộp thư.</p>
        </div>

        @* FORM ĐỔI MẬT KHẨU *@
        <form id="changePasswordForm" asp-controller="User" asp-action="ChangePassword" method="post" autocomplete="off" class="row g-4">

            <div class="col-12 position-relative">
                <label for="oldPassword" class="form-label fw-medium">Mật khẩu cũ:</label>
                <input type="password" name="oldPassword" id="oldPassword" class="form-control rounded-3 py-2" required />
                <i class="fas fa-eye toggle-password" data-target="#oldPassword"></i>
            </div>

            <div class="col-md-6 position-relative">
                <label for="newPassword" class="form-label fw-medium">Mật khẩu mới:</label>
                <input type="password" name="newPassword" id="newPassword" class="form-control rounded-3 py-2" required />
                <i class="fas fa-eye toggle-password" data-target="#newPassword"></i>
            </div>

            <div class="col-md-6 position-relative">
                <label for="confirmPassword" class="form-label fw-medium">Xác nhận mật khẩu mới:</label>
                <input type="password" name="confirmPassword" id="confirmPassword" class="form-control rounded-3 py-2" required />
                <i class="fas fa-eye toggle-password" data-target="#confirmPassword"></i>
            </div>

            <div class="col-12">
                <label for="verificationCode" class="form-label fw-medium">Mã xác nhận (OTP):</label>
                <input type="text" name="verificationCode" id="verificationCode" class="form-control rounded-3 py-2 text-center fs-5" required disabled placeholder="Nhập mã OTP 6 số" />
            </div>

            <div id="otpMessage" class="text-success fw-bold"></div> @* Dùng để hiển thị lỗi/thông báo validation JS *@

            <div class="col-12 text-center d-flex justify-content-center gap-3 mt-4">
                <button type="button" id="sendOtpBtn" class="btn btn-primary btn-lg rounded-pill px-5 fw-bold">
                    <i class="fas fa-paper-plane me-2"></i>Gửi mã xác nhận
                </button>
                <button type="submit" id="submitPasswordBtn" class="btn btn-success btn-lg rounded-pill px-5 fw-bold" disabled>
                    <i class="fas fa-save me-2"></i>Xác nhận đổi mật khẩu
                </button>
            </div>
        </form>

        <div class="footer text-center mt-4 pt-3 border-top">
            <a href="@Url.Action("UpdateProfile", "User")" class="btn btn-link text-secondary"><i class="fas fa-arrow-left me-2"></i>Quay lại Hồ sơ</a>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.3/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/aos/2.3.4/aos.js"></script>
    <script>
        $(document).ready(function () {
            // Khởi tạo AOS
            if (typeof AOS !== 'undefined') {
                AOS.init({ duration: 800, once: true, offset: 50 });
            }

            // Toggle password visibility
            $(".toggle-password").click(function () {
                var input = $($(this).attr("data-target"));
                if (input.attr("type") === "password") {
                    input.attr("type", "text");
                    $(this).removeClass("fa-eye").addClass("fa-eye-slash");
                } else {
                    input.attr("type", "password");
                    $(this).removeClass("fa-eye-slash").addClass("fa-eye");
                }
            });

            function setValidationMessage(msg, isSuccess = false) {
                const msgElement = $("#otpMessage");
                msgElement.text(msg);
                if (isSuccess) {
                    msgElement.removeClass("text-danger").addClass("text-success");
                } else {
                    msgElement.removeClass("text-success").addClass("text-danger");
                }
            }

            function validatePasswords() {
                var oldPassword = $("#oldPassword").val().trim();
                var newPassword = $("#newPassword").val().trim();
                var confirmPassword = $("#confirmPassword").val().trim();

                if (oldPassword === "" || newPassword === "" || confirmPassword === "") {
                    setValidationMessage("Vui lòng điền đủ các trường mật khẩu.");
                    return false;
                }

                // Quy tắc mật khẩu: Tối thiểu 8 ký tự, có chữ hoa, chữ thường, số
                const passwordRegex = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d).{8,}$/;

                if (!passwordRegex.test(newPassword)) {
                    setValidationMessage("Mật khẩu mới phải có ít nhất 8 ký tự, bao gồm chữ hoa, chữ thường và chữ số.");
                    return false;
                }

                if (newPassword !== confirmPassword) {
                    setValidationMessage("Mật khẩu mới và xác nhận mật khẩu không khớp.");
                    return false;
                }

                setValidationMessage("Mật khẩu hợp lệ. Bạn có thể gửi mã xác nhận.", true);
                return true;
            }

            // Sự kiện click nút Gửi OTP
            $("#sendOtpBtn").click(function () {
                if (!validatePasswords()) {
                    return;
                }

                // Gửi yêu cầu OTP qua AJAX
                $.ajax({
                    url: '@Url.Action("SendVerificationCode", "User")',
                    type: "POST",
                    data: {
                        oldPassword: $("#oldPassword").val(),
                        newPassword: $("#newPassword").val() // Có thể gửi mật khẩu mới lên server để tạm lưu token
                    },
                    beforeSend: function () {
                        $("#sendOtpBtn").prop("disabled", true).html('<i class="fas fa-spinner fa-spin me-2"></i>Đang gửi...');
                    },
                    success: function (response) {
                        if (response.success) {
                            $("#otpContainer").slideDown();
                            $("#otpMessage").removeClass("text-danger").addClass("text-success").text("Mã OTP đã được gửi đến email của bạn.");
                            $("#verificationCode").prop("disabled", false).val("").focus();
                            $("#submitPasswordBtn").prop("disabled", false).show();
                            $("#sendOtpBtn").html('<i class="fas fa-paper-plane me-2"></i>Gửi lại mã OTP');

                            // Hiển thị 3 ký tự đầu tiên của OTP (nếu server trả về)
                            if (response.otp && response.otp.length > 0) {
                                $("#otpPreview").text(response.otp.substring(0, 3) + "*****");
                            }

                        } else {
                            setValidationMessage("Lỗi: " + (response.message || "Không thể gửi mã OTP"), false);
                        }
                    },
                    error: function (xhr) {
                        setValidationMessage("Lỗi kết nối hoặc yêu cầu không hợp lệ. Vui lòng kiểm tra lại mật khẩu cũ.", false);
                    },
                    complete: function () {
                        $("#sendOtpBtn").prop("disabled", false);
                    }
                });
            });

            // Xử lý sự kiện Submit Form cuối cùng
            $("#changePasswordForm").submit(function (e) {
                var otp = $("#verificationCode").val().trim();

                if (!validatePasswords() || otp === "" || $("#verificationCode").is(':disabled')) {
                    e.preventDefault();
                    setValidationMessage("Vui lòng nhập mật khẩu hợp lệ và gửi/nhập mã OTP trước khi xác nhận.", false);
                    return false;
                }
                // Thêm xác nhận cuối cùng cho OTP
                if (otp.length < 6) {
                    e.preventDefault();
                    setValidationMessage("Mã OTP phải có 6 ký tự.", false);
                    return false;
                }

                return true;
            });
        });
    </script>
}