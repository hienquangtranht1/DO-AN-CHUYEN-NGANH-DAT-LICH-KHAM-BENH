@model BookinhMVC.Models.BenhNhan
@{
    Layout = "_AdminLayout";
    ViewBag.Active = "Patients";
    ViewBag.Title = "Chỉnh sửa Hồ sơ Bệnh nhân";

    var currentImgSrc = !string.IsNullOrEmpty(Model.HinhAnhBenhNhan)
        ? (Model.HinhAnhBenhNhan.StartsWith("/uploads") ? Model.HinhAnhBenhNhan : "/uploads/" + Model.HinhAnhBenhNhan)
        : "/images/default-patient.png";
}

<div class="row">
    <div class="col-lg-8 offset-lg-2">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="mb-0"><i class="fas fa-edit me-2 text-warning"></i>Chỉnh sửa Hồ sơ Bệnh nhân</h2>
        </div>

        <div class="card shadow-lg border-0">
            <div class="card-body p-4">
                <form asp-action="EditPatient" method="post" enctype="multipart/form-data">
                    @* Anti-forgery token *@
                    @Html.AntiForgeryToken()

                    @* Hidden Inputs quan trọng *@
                    <input type="hidden" name="id" value="@Model.MaBenhNhan" />
                    <input type="hidden" name="maNguoiDung" value="@Model.MaBenhNhan" />
                    <input type="hidden" name="hinhAnhBenhNhan" value="@Model.HinhAnhBenhNhan" />

                    <h4 class="mb-3 text-primary border-bottom pb-2">
                        <i class="fas fa-user me-2"></i> Thông tin cá nhân
                    </h4>

                    <div class="row">
                        @* Cột 1 *@
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="hoTen" class="form-label fw-bold">Họ tên (<span class="text-danger">*</span>)</label>
                                <input type="text" id="hoTen" name="hoTen" class="form-control" value="@(Model.HoTen ?? "")" required />
                            </div>

                            <div class="mb-3">
                                <label for="ngaySinh" class="form-label fw-bold">Ngày sinh (<span class="text-danger">*</span>)</label>
                                <input name="ngaySinh" type="date" id="ngaySinh" class="form-control"
                                       value="@(Model.NgaySinh.HasValue ? Model.NgaySinh.Value.ToString("yyyy-MM-dd") : "")" required />
                            </div>
                        </div>

                        @* Cột 2 *@
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="gioiTinh" class="form-label fw-bold">Giới tính (<span class="text-danger">*</span>)</label>
                                <select id="gioiTinh" name="gioiTinh" class="form-select" required>
                                    @if ((Model.GioiTinh ?? "").Equals("Nam", StringComparison.OrdinalIgnoreCase))
                                    {
                                        <option value="Nam" selected>Nam</option>
                                        <option value="Nữ">Nữ</option>
                                        <option value="Khác">Khác</option>
                                    }
                                    else if ((Model.GioiTinh ?? "").Equals("Nữ", StringComparison.OrdinalIgnoreCase))
                                    {
                                        <option value="Nam">Nam</option>
                                        <option value="Nữ" selected>Nữ</option>
                                        <option value="Khác">Khác</option>
                                    }
                                    else
                                    {
                                        <option value="Nam">Nam</option>
                                        <option value="Nữ">Nữ</option>
                                        <option value="Khác" selected>Khác</option>
                                    }
                                </select>
                            </div>

                            <div class="mb-3">
                                <label for="soDienThoai" class="form-label fw-bold">Số điện thoại</label>
                                <input type="tel" id="soDienThoai" name="soDienThoai" class="form-control"
                                       value="@(Model.SoDienThoai ?? "")" placeholder="Ví dụ: 090xxxxxxx" />
                            </div>
                        </div>
                    </div>

                    <div class="mb-4">
                        <label for="email" class="form-label fw-bold">Email</label>
                        <input type="email" id="email" name="email" class="form-control"
                               value="@(Model.Email ?? "")" placeholder="Ví dụ: patient@example.com" />
                    </div>

                    <h4 class="mt-4 mb-3 text-primary border-bottom pb-2">
                        <i class="fas fa-map-marker-alt me-2"></i> Địa chỉ & Bảo hiểm
                    </h4>

                    <div class="mb-3">
                        <label for="diaChi" class="form-label fw-bold">Địa chỉ</label>
                        <textarea id="diaChi" name="diaChi" class="form-control" rows="2"
                                  placeholder="Nhập địa chỉ đầy đủ">@(Model.DiaChi ?? "")</textarea>
                    </div>

                    <div class="mb-4">
                        <label for="soBaoHiem" class="form-label fw-bold">Số bảo hiểm y tế</label>
                        <input type="text" id="soBaoHiem" name="soBaoHiem" class="form-control"
                               value="@(Model.SoBaoHiem ?? "")" placeholder="Nhập số thẻ BHYT" />
                    </div>

                    <h4 class="mt-4 mb-3 text-primary border-bottom pb-2">
                        <i class="fas fa-camera me-2"></i> Ảnh hồ sơ
                    </h4>

                    <div class="row mb-4 align-items-center">
                        <div class="col-md-4">
                            <label class="form-label fw-bold">Ảnh hiện tại</label>
                            <div class="text-center p-2 border rounded">
                                <img src="@currentImgSrc"
                                     alt="Hình ảnh bệnh nhân @(Model.HoTen ?? "")"
                                     class="img-fluid rounded-circle"
                                     style="width: 100px; height: 100px; object-fit: cover;"
                                     onerror="this.onerror=null; this.src='/images/default-patient.png';" />
                            </div>
                        </div>

                        <div class="col-md-8">
                            <label for="file" class="form-label fw-bold">Chọn ảnh mới</label>
                            <input type="file" id="file" name="file" class="form-control" accept="image/*" />
                            <div class="form-text">Chọn tệp mới để thay thế ảnh hiện tại.</div>
                        </div>
                    </div>

                    <div class="d-flex justify-content-end pt-3 border-top">
                        <a href="/Admin/Patients" class="btn btn-secondary me-2">
                            <i class="fas fa-arrow-left me-1"></i> Quay lại
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-1"></i> Lưu thay đổi
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
