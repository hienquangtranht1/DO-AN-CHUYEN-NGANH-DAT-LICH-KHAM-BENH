@* File: Views/User/Register.cshtml *@
@{
    ViewData["Title"] = "Đăng ký tài khoản";
    Layout = "~/Views/Shared/_Layout.cshtml";

    var error = ViewData["Error"] as string;
}

<div class="container my-5 pt-5">
    <div class="register-container mx-auto col-lg-8 col-md-10 col-sm-12 p-4 p-md-5 rounded-4 shadow-lg bg-white" data-aos="fade-up">
        <h2 class="text-center mb-4 fw-bold text-primary">
            <i class="fas fa-user-plus me-2"></i> Đăng ký tài khoản Bệnh nhân
        </h2>
        <p class="text-center text-secondary mb-4">Vui lòng điền đầy đủ thông tin để tạo tài khoản khám chữa bệnh tại Four Rock Hospital.</p>

        @* Hiển thị lỗi Server-side (Nếu có, ví dụ: sau khi quay lại từ VerifyOtp) *@
        @if (!ViewData.ModelState.IsValid && ViewData.ModelState.Values.Any(v => v.Errors.Count > 0))
        {
            <div class="alert alert-danger rounded-3">
                <i class="fas fa-times-circle me-2"></i>
                Có lỗi xảy ra:
                @foreach (var modelError in ViewData.ModelState.Values.SelectMany(v => v.Errors))
                {
                    <div class="ms-3">- @modelError.ErrorMessage</div>
                }
            </div>
        }

        @* FORM ĐĂNG KÝ *@
        <form asp-controller="User" asp-action="Register" method="post" class="row g-4">

            <h5 class="fw-bold text-dark mt-4 border-bottom pb-2"><i class="fas fa-id-card me-2 text-info"></i> Thông tin truy cập</h5>

            <div class="col-md-6">
                <label for="username" class="form-label fw-medium">Tên đăng nhập (<span class="text-danger">*</span>)</label>
                <input type="text" class="form-control rounded-3 py-2" id="username" name="username"
                       required minlength="4" maxlength="50" pattern="^[a-zA-Z0-9]+$"
                       title="Chỉ chứa chữ cái và số, tối thiểu 4 ký tự." />
                @* Vùng hiển thị lỗi AJAX *@
                <div class="text-danger mt-1 validation-error" id="username-error"></div>
            </div>
            <div class="col-md-6">
                <label for="password" class="form-label fw-medium">Mật khẩu (<span class="text-danger">*</span>)</label>
                <input type="password" class="form-control rounded-3 py-2" id="password" name="password"
                       required minlength="6" maxlength="100"
                       title="Mật khẩu phải có ít nhất 6 ký tự." />
                @* Vùng hiển thị lỗi MỚI *@
                <div class="text-danger mt-1 validation-error" id="password-error"></div>
            </div>

            <h5 class="fw-bold text-dark mt-4 border-bottom pb-2"><i class="fas fa-user me-2 text-info"></i> Thông tin cá nhân</h5>

            <div class="col-md-6">
                <label for="fullname" class="form-label fw-medium">Họ và tên (<span class="text-danger">*</span>)</label>
                <input type="text" class="form-control rounded-3 py-2" id="fullname" name="fullname"
                       required maxlength="100"
                       title="Vui lòng nhập họ và tên đầy đủ." />
            </div>
            <div class="col-md-6">
                <label for="dob" class="form-label fw-medium">Ngày sinh (<span class="text-danger">*</span>)</label>
                <input type="date" class="form-control rounded-3 py-2" id="dob" name="dob"
                       required max="@DateTime.Today.ToString("yyyy-MM-dd")"
                       title="Ngày sinh không thể là ngày trong tương lai." />
            </div>

            <div class="col-md-6">
                <label for="gender" class="form-label fw-medium">Giới tính (<span class="text-danger">*</span>)</label>
                <select class="form-select rounded-3 py-2" id="gender" name="gender" required>
                    <option value="Nam">Nam</option>
                    <option value="Nữ">Nữ</option>
                    <option value="Khác">Khác</option>
                </select>
            </div>
            <div class="col-md-6">
                <label for="soBaoHiem" class="form-label fw-medium">Bảo hiểm Y tế (<span class="text-danger">*</span>)</label>
                <input type="text" class="form-control rounded-3 py-2" id="soBaoHiem" name="soBaoHiem"
                       placeholder="Số BHYT (nếu có)" required maxlength="20"
                       title="Số BHYT tối đa 20 ký tự." />
                @* Vùng hiển thị lỗi AJAX *@
                <div class="text-danger mt-1 validation-error" id="sobaohiem-error"></div>
            </div>

            <h5 class="fw-bold text-dark mt-4 border-bottom pb-2"><i class="fas fa-address-book me-2 text-info"></i> Thông tin liên hệ</h5>

            <div class="col-md-6">
                <label for="phone" class="form-label fw-medium">Số điện thoại (<span class="text-danger">*</span>)</label>
                <input type="tel" class="form-control rounded-3 py-2" id="phone" name="phone"
                       required minlength="10" maxlength="10"
                       pattern="^0\d{9}$"
                       title="Phải có 10 chữ số và bắt đầu bằng 0 (VD: 0987654321)." />
                @* Vùng hiển thị lỗi AJAX *@
                <div class="text-danger mt-1 validation-error" id="phone-error"></div>
            </div>
            <div class="col-md-6">
                <label for="email" class="form-label fw-medium">Email (<span class="text-danger">*</span>)</label>
                <input type="email" class="form-control rounded-3 py-2" id="email" name="email"
                       required maxlength="100"
                       title="Vui lòng nhập định dạng email hợp lệ.(example@gmail.com)" />
                @* Vùng hiển thị lỗi AJAX *@
                <div class="text-danger mt-1 validation-error" id="email-error"></div>
            </div>
            <div class="col-12">
                <label for="address" class="form-label fw-medium">Địa chỉ</label>
                <input type="text" class="form-control rounded-3 py-2" id="address" name="address"
                       placeholder="Địa chỉ hiện tại" maxlength="255"
                       title="Địa chỉ không được quá 255 ký tự." />
            </div>

            <div class="col-12 text-center mt-5">
              
                <button type="submit" class="btn btn-primary btn-lg rounded-pill px-5 fw-bold me-3">
                    <i class="fas fa-check-circle me-2"></i> Gửi đăng ký
                </button>
                <a asp-controller="User" asp-action="Login" class="btn btn-outline-secondary btn-lg rounded-pill px-5 fw-bold">
                    Quay lại Đăng nhập
                </a>
            </div>
        </form>
    </div>
</div>

@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/aos/2.3.4/aos.js"></script>
    <script>
        // Khởi tạo AOS
        if (typeof AOS !== 'undefined') {
            AOS.init({
                duration: 800,
                once: true,
                offset: 50
            });
        }

        $(document).ready(function () {
            // Biến theo dõi trạng thái validation của các trường AJAX VÀ Password
            // Mặc định tất cả là FALSE. Vẫn cần để JS thực hiện hiển thị màu đỏ/xanh lá
            var validationStatus = {
                username: false,
                email: false,
                sobaohiem: false,
                phone: false,
                password: false
            };

            // Hàm kiểm tra độ dài Mật khẩu
            function checkPasswordValidity() {
                var element = $('#password');
                var fieldValue = element.val();
                var errorElement = $('#password-error');

                // Kiểm tra độ dài tối thiểu 6 ký tự
                if (fieldValue.length >= 6) {
                    errorElement.text('');
                    element.addClass('is-valid').removeClass('is-invalid');
                    validationStatus.password = true;
                } else {
                    errorElement.text('Mật khẩu phải có ít nhất 6 ký tự.');
                    element.addClass('is-invalid').removeClass('is-valid');
                    validationStatus.password = false;
                }
            }

            // Hàm thực hiện kiểm tra qua AJAX (logic không đổi)
            function checkFieldUniqueness(fieldName, element) {
                var fieldValue = element.val().trim();
                var errorElement = $('#' + fieldName + '-error');

                // 1. Reset trạng thái và kiểm tra HTML5 cơ bản (Client-side)
                element.removeClass('is-invalid is-valid');
                errorElement.text('');
                validationStatus[fieldName] = false;

                // Kiểm tra HTML5 cơ bản (Required, pattern, minlength)
                if (element[0].checkValidity() === false) {
                    if (element.prop('required') && fieldValue === '') {
                        errorElement.text('Trường này là bắt buộc.');
                    } else {
                        errorElement.text(element.attr('title'));
                    }
                    element.addClass('is-invalid');
                    return;
                }

                // Nếu hợp lệ HTML5, tiến hành AJAX check
                // 2. Thực hiện AJAX call (Server-side validation)
                $.ajax({
                    url: '@Url.Action("CheckUniqueness", "User")',
                    type: 'POST',
                    data: { fieldName: fieldName, fieldValue: fieldValue },
                    beforeSend: function() {
                        errorElement.html('<span class="text-secondary"><i class="fas fa-spinner fa-spin me-1"></i>Đang kiểm tra...</span>');
                    },
                    success: function (response) {
                        if (response.isUnique) {
                            errorElement.text('');
                            element.addClass('is-valid').removeClass('is-invalid');
                            validationStatus[fieldName] = true;
                        } else {
                            errorElement.text(response.errorMessage);
                            element.addClass('is-invalid').removeClass('is-valid');
                            validationStatus[fieldName] = false;
                        }
                    },
                    error: function () {
                        errorElement.text('Lỗi kết nối Server.');
                        element.addClass('is-invalid').removeClass('is-valid');
                        validationStatus[fieldName] = false;
                    }
                });
            }

            // --- GÁN SỰ KIỆN ---

            // Gán sự kiện cho các trường AJAX (username, email, phone, soBaoHiem)
            $('#username').on('blur', function () {
                checkFieldUniqueness('username', $(this));
            });

            // Gán sự kiện cho Mật khẩu (Password)
            $('#password').on('input blur', checkPasswordValidity);

            $('#email').on('blur', function () {
                checkFieldUniqueness('email', $(this));
            });

            $('#phone').on('blur', function () {
                checkFieldUniqueness('phone', $(this));
            });

            $('#soBaoHiem').on('blur', function () {
                checkFieldUniqueness('sobaohiem', $(this));
            });

            // Kích hoạt kiểm tra khi tải trang nếu có dữ liệu cũ
            setTimeout(function() {
                $('#username').trigger('blur');
                $('#email').trigger('blur');
                $('#phone').trigger('blur');
                $('#soBaoHiem').trigger('blur');
                checkPasswordValidity();
            }, 500);

            // Bỏ qua hàm updateSubmitButton() để nút luôn được mở

        });
    </script>
}

<style>
    /* Custom styles for consistency */
    .register-container {
        background-color: #fff;
        border: 1px solid #e9ecef;
    }

    .form-control, .form-select {
        transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
    }

        .form-control:focus, .form-select:focus {
            border-color: #80bdff;
            box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
        }

        /* Thêm style cho trạng thái validation */
        .form-control.is-invalid, .form-select.is-invalid {
            border-color: #dc3545 !important;
        }

        .form-control.is-valid, .form-select.is-valid {
            border-color: #198754 !important;
        }

    .btn-primary {
        background-color: #0d6efd;
        border-color: #0d6efd;
    }

        .btn-primary:hover {
            background-color: #0b5ed7;
            border-color: #0a58ca;
        }

        /* Đã bỏ qua [disabled], nhưng giữ lại style nếu muốn áp dụng ở nơi khác */
        .btn-primary[disabled] {
            opacity: 0.65;
            cursor: not-allowed;
        }

    .btn-outline-secondary {
        border-color: #6c757d;
        color: #6c757d;
    }

        .btn-outline-secondary:hover {
            background-color: #6c757d;
            color: white;
        }

    /* Responsive adjustment for small screens */
    @@media (max-width: 768px) {
        .register-container {
            padding: 1.5rem !important;
        }
    }
</style>